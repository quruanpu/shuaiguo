<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº·åº·è€å¸ˆçš„è´¨é‡é—®é¢˜è¸¢çš®çƒå¤§æˆ˜</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .game-container {
            text-align: center;
            position: relative;
        }
        
        canvas {
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .title {
            color: #fff;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: bounce 2s infinite;
        }
        
        .department-scores {
            display: flex;
            justify-content: space-between;
            color: #fff;
            font-size: 1em;
            margin-top: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            gap: 20px;
        }
        
        .score-box {
            padding: 8px 15px;
            border-radius: 10px;
            border: 2px solid;
            min-width: 120px;
        }
        
        .quality-score {
            background: rgba(46, 204, 113, 0.8);
            border-color: #27ae60;
        }
        
        .procurement-score {
            background: rgba(231, 76, 60, 0.8);
            border-color: #c0392b;
        }
        
        .operations-score {
            background: rgba(52, 152, 219, 0.8);
            border-color: #2980b9;
        }
        
        .customer-pressure {
            background: rgba(155, 89, 182, 0.8);
            border-color: #8e44ad;
        }
        
        .instructions {
            color: #fff;
            font-size: 0.9em;
            margin-top: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            max-width: 900px;
        }
        
        .emergency-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #e74c3c, #f39c12);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            animation: emergencyPulse 1s infinite;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        @keyframes emergencyPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="title">ğŸ”¥ åº·åº·è€å¸ˆçš„è´¨é‡é—®é¢˜è¸¢çš®çƒå¤§ä½œæˆ˜ ğŸ”¥</h1>
        <button class="emergency-btn" onclick="createEmergencyIssue()">ğŸš¨ ç´§æ€¥è´¨é‡é—®é¢˜</button>
        <canvas id="gameCanvas" width="900" height="650"></canvas>
        <div class="department-scores">
            <div class="score-box quality-score">
                ğŸ” è´¨ç®¡éƒ¨<br>
                æ‹‰ç¾¤æ¬¡æ•°: <span id="qualityScore">0</span><br>
                æ— è¯­æŒ‡æ•°: <span id="frustrationLevel">0</span>
            </div>
            <div class="score-box procurement-score">
                ğŸ›’ é‡‡è´­éƒ¨ (åº·åº·)<br>
                é€€ç¾¤æ¬¡æ•°: <span id="procurementScore">0</span><br>
                ç”©é”…æˆåŠŸ: <span id="procurementDodge">0</span>
            </div>
            <div class="score-box operations-score">
                ğŸ“Š è¿è¥éƒ¨<br>
                åå‡»æ¬¡æ•°: <span id="operationsScore">0</span><br>
                åæ§½æ¬¡æ•°: <span id="operationsComplaint">0</span>
            </div>
            <div class="score-box customer-pressure">
                ğŸ˜¡ å®¢æˆ·å‹åŠ›<br>
                å‚¬ä¿ƒæ¬¡æ•°: <span id="customerPressure">0</span><br>
                æ„¤æ€’å€¼: <span id="customerAnger">0</span>
            </div>
        </div>
        <div class="instructions">
            ç‚¹å‡»è´¨é‡é—®é¢˜è®©è´¨ç®¡æ‹‰ç¾¤ï¼ç‚¹å‡»åº·åº·è®©ä»–é€€ç¾¤ï¼æŒ‰ç©ºæ ¼é”®è¿è¥åæ§½ï¼æŒ‰Ré”®é‡‡è´­ç”©é”…ï¼å®¢æˆ·è¶Šæ¥è¶Šæ„¤æ€’ï¼
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // åˆ†æ•°å…ƒç´ 
        const qualityScoreElement = document.getElementById('qualityScore');
        const procurementScoreElement = document.getElementById('procurementScore');
        const operationsScoreElement = document.getElementById('operationsScore');
        const customerPressureElement = document.getElementById('customerPressure');
        const frustrationLevelElement = document.getElementById('frustrationLevel');
        const procurementDodgeElement = document.getElementById('procurementDodge');
        const operationsComplaintElement = document.getElementById('operationsComplaint');
        const customerAngerElement = document.getElementById('customerAnger');
        
        // æ¸¸æˆçŠ¶æ€
        let gameStats = {
            qualityGroupCreated: 0,
            procurementQuits: 0,
            operationsComplaints: 0,
            customerPressure: 0,
            frustrationLevel: 0,
            procurementDodge: 0,
            customerAnger: 0
        };
        
        let qualityIssues = [];
        let groupChats = [];
        let excuses = [];
        let particles = [];
        let customerComplaints = [];
        let flowchartSteps = [];
        
        // è§’è‰²å®šä¹‰
        let characters = {
            qualityManager: {
                x: 150,
                y: canvas.height - 150,
                mood: 'stressed',
                name: 'è´¨ç®¡å°ç‹',
                armAngle: 0,
                isCreatingGroup: false
            },
            kangkangTeacher: {
                x: 450,
                y: canvas.height - 150,
                mood: 'avoidance',
                name: 'åº·åº·è€å¸ˆ',
                armAngle: 0,
                isQuitting: false,
                quitCount: 0
            },
            operationsManager: {
                x: 750,
                y: canvas.height - 150,
                mood: 'frustrated',
                name: 'è¿è¥é˜¿æ˜',
                armAngle: 0,
                isComplaining: false
            }
        };
        
        // è´¨é‡é—®é¢˜ç±»å‹
        const qualityIssueTypes = [
            { name: "äº§å“å°ºå¯¸åå·®", severity: 3, urgency: "ä¸­ç­‰", color: "#f39c12", customerImpact: "ä¸­" },
            { name: "ææ–™è´¨é‡é—®é¢˜", severity: 4, urgency: "ç´§æ€¥", color: "#e74c3c", customerImpact: "é«˜" },
            { name: "åŒ…è£…ç ´æŸ", severity: 2, urgency: "ä¸€èˆ¬", color: "#3498db", customerImpact: "ä½" },
            { name: "é¢œè‰²å·®å¼‚", severity: 3, urgency: "ä¸­ç­‰", color: "#9b59b6", customerImpact: "ä¸­" },
            { name: "åŠŸèƒ½ç¼ºé™·", severity: 5, urgency: "ç´§æ€¥", color: "#c0392b", customerImpact: "æé«˜" },
            { name: "æ ‡ç­¾é”™è¯¯", severity: 2, urgency: "ä¸€èˆ¬", color: "#27ae60", customerImpact: "ä½" },
            { name: "æ•°é‡çŸ­ç¼º", severity: 4, urgency: "ç´§æ€¥", color: "#e67e22", customerImpact: "é«˜" },
            { name: "äº¤è´§å»¶è¿Ÿ", severity: 3, urgency: "ä¸­ç­‰", color: "#34495e", customerImpact: "ä¸­" }
        ];
        
        // åº·åº·è€å¸ˆé€€ç¾¤å€Ÿå£
        const kangkangQuitExcuses = [
            "è¿™ä¸ªæˆ‘ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œä½ ä»¬å…ˆèŠ",
            "æˆ‘è¿™è¾¹åœ¨å¼€ä¼šï¼Œå…ˆé€€äº†",
            "è¿™ä¸ªé—®é¢˜ä¸åœ¨æˆ‘ä»¬é‡‡è´­èŒƒå›´å†…",
            "ä¾›åº”å•†çš„é—®é¢˜åº”è¯¥æ‰¾è¿è¥åè°ƒ",
            "æˆ‘éœ€è¦å…ˆäº†è§£æƒ…å†µï¼Œå›å¤´å†è¯´",
            "è¿™ä¸ªæµç¨‹æˆ‘ä»¬æ²¡å‚ä¸è¿‡",
            "è®©æˆ‘å…ˆé—®é—®é¢†å¯¼ä»€ä¹ˆæ„æ€",
            "æˆ‘æ‰‹æœºè¦æ²¡ç”µäº†ï¼Œå…ˆæ’¤",
            "æˆ‘ä»¥ä¸ºè¿™æ˜¯è¿è¥è´Ÿè´£çš„",
            "ç¨ç­‰ï¼Œæˆ‘å¦ˆå–Šæˆ‘åƒé¥­",
            "è¿™ä¸ªæˆ‘éœ€è¦æŸ¥ä¸€ä¸‹åˆåŒ",
            "ä¿¡å·ä¸å¥½ï¼Œæˆ‘å…ˆèµ°äº†"
        ];
        
        // è¿è¥éƒ¨åæ§½è¯­å½•
        const operationsComplaints = [
            "åˆæ˜¯é‡‡è´­çš„é”…ï¼",
            "ä¾›åº”å•†éƒ½æ˜¯é‡‡è´­æ‰¾çš„å¥½å§ï¼",
            "è¿™ä¸ªæ˜æ˜åº”è¯¥é‡‡è´­è´Ÿè´£ï¼",
            "åº·åº·è€å¸ˆåˆè·‘è·¯äº†ï¼",
            "é‡‡è´­ä¸ºä»€ä¹ˆä¸æŠŠå…³è´¨é‡ï¼Ÿ",
            "è¿™ç§é—®é¢˜åº”è¯¥åœ¨é‡‡è´­ç¯èŠ‚å‘ç°ï¼",
            "æ¯æ¬¡éƒ½è®©æˆ‘ä»¬è¿è¥èƒŒé”…ï¼",
            "é‡‡è´­çš„å·¥ä½œå°±æ˜¯ç¡®ä¿è´¨é‡å•Šï¼",
            "åº·åº·è€å¸ˆä¸“ä¸šç”©é”…ä¸‰åå¹´ï¼",
            "è´¨ç®¡æ‹‰ç¾¤é‡‡è´­ç§’é€€ï¼Œæˆ‘ç¬‘äº†",
            "é‡‡è´­éƒ¨å°±ä¼šè¸¢çš®çƒï¼",
            "å®¢æˆ·éƒ½è¦æ°”æ­»äº†è¿˜åœ¨æ¨è¯¿ï¼"
        ];
        
        // è´¨ç®¡æ— è¯­è¯­å½•
        const qualityManagerComplains = [
            "æˆ‘å·²ç»æ‹‰ç¾¤ä¸‰æ¬¡äº†ï¼",
            "èƒ½ä¸èƒ½è®¤çœŸè§£å†³é—®é¢˜ï¼Ÿ",
            "å®¢æˆ·éƒ½å‚¬ç–¯äº†ï¼",
            "è¿™ä¸ªæµç¨‹åˆ°åº•è°è´Ÿè´£ï¼Ÿ",
            "åº·åº·è€å¸ˆåˆé€€ç¾¤äº†...",
            "æˆ‘å¤ªéš¾äº†...",
            "èƒ½ä¸èƒ½åˆ«æ¨æ¥æ¨å»ï¼Ÿ",
            "è¿™æ ·ä¸‹å»å®¢æˆ·è¦æŠ•è¯‰äº†ï¼",
            "æˆ‘åªæ˜¯æƒ³è§£å†³é—®é¢˜å•Šï¼",
            "ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½è¿™æ ·ï¼Ÿ",
            "å¤§å®¶èƒ½ä¸èƒ½é…åˆä¸€ä¸‹ï¼Ÿ",
            "æˆ‘çš„è¡€å‹è¦ä¸Šæ¥äº†ï¼"
        ];
        
        // å®¢æˆ·æ„¤æ€’è¯­å½•
        const customerAngryComments = [
            "ä»€ä¹ˆæ—¶å€™èƒ½è§£å†³ï¼Ÿï¼",
            "è¿™éƒ½ç¬¬å‡ å¤©äº†ï¼Ÿ",
            "ä½ ä»¬åˆ°åº•è¡Œä¸è¡Œï¼Ÿ",
            "æˆ‘è¦æŠ•è¯‰ï¼",
            "æœåŠ¡æ€åº¦å¤ªå·®äº†ï¼",
            "ä¸‹æ¬¡ä¸åˆä½œäº†ï¼",
            "è¿™ç§è´¨é‡è¿˜æ•¢å–ï¼Ÿ",
            "æˆ‘è¦æ‰¾ä½ ä»¬è€æ¿ï¼",
            "èµ”å¿æ–¹æ¡ˆå‘¢ï¼Ÿ",
            "è€½è¯¯æˆ‘ä»¬ç”Ÿäº§äº†ï¼",
            "ç´§æ€¥ç´§æ€¥ç´§æ€¥ï¼",
            "é©¬ä¸Šç»™æˆ‘å¤„ç†ï¼"
        ];
        
        // é‡‡è´­ç”©é”…è¯­å½•
        const procurementDodgeExcuses = [
            "è¿™æ˜¯è´¨é‡é—®é¢˜ï¼Œåº”è¯¥è´¨ç®¡è´Ÿè´£",
            "æˆ‘ä»¬åªè´Ÿè´£ä¸‹å•ï¼Œä¸ç®¡è´¨é‡",
            "åˆåŒé‡Œæ²¡å†™è¿™ä¸ªè´£ä»»",
            "ä¾›åº”å•†é—®é¢˜æ‰¾è¿è¥åè°ƒ",
            "è¿™ç§æŠ€æœ¯é—®é¢˜æˆ‘ä»¬ä¸æ‡‚",
            "æŒ‰æµç¨‹åº”è¯¥æ˜¯è¿è¥å¤„ç†",
            "æˆ‘ä»¬é‡‡è´­åªç®¡ä»·æ ¼å’Œäº¤æœŸ",
            "è´¨é‡æ ‡å‡†æ˜¯è¿è¥å®šçš„",
            "è¿™ä¸ªéœ€è¦æŠ€æœ¯éƒ¨é—¨ä»‹å…¥",
            "æˆ‘ä»¬å·²ç»æŒ‰è¦æ±‚ä¸‹å•äº†",
            "åç»­é—®é¢˜ä¸å½’æˆ‘ä»¬ç®¡",
            "è¿è¥åº”è¯¥å’Œå®¢æˆ·è§£é‡Š"
        ];
        
        // è´¨é‡é—®é¢˜ç±»
        class QualityIssue {
            constructor() {
                this.reset();
                this.type = qualityIssueTypes[Math.floor(Math.random() * qualityIssueTypes.length)];
                this.id = 'QC' + Date.now().toString().slice(-6);
                this.status = 'pending';
                this.assignedTo = 'none';
                this.customerComplaintCount = 0;
            }
            
            reset() {
                this.x = Math.random() * (canvas.width - 200) + 100;
                this.y = -100;
                this.vy = Math.random() * 1 + 0.5;
                this.clicked = false;
                this.blinkTimer = 0;
            }
            
            update() {
                if (!this.clicked) {
                    this.y += this.vy;
                    this.blinkTimer += 0.1;
                    
                    // å®¢æˆ·å‚¬ä¿ƒ
                    if (Math.random() < 0.002) {
                        this.customerComplaintCount++;
                        gameStats.customerPressure++;
                        gameStats.customerAnger++;
                        customerPressureElement.textContent = gameStats.customerPressure;
                        customerAngerElement.textContent = gameStats.customerAnger;
                        this.showCustomerComplaint();
                    }
                }
                
                if (this.y > canvas.height + 100) {
                    this.reset();
                }
            }
            
            draw() {
                if (this.clicked) return;
                
                ctx.save();
                
                // æ ¹æ®ä¸¥é‡ç¨‹åº¦é—ªçƒ
                const alpha = this.type.severity > 3 ? 
                    0.8 + Math.sin(this.blinkTimer) * 0.2 : 0.9;
                ctx.globalAlpha = alpha;
                
                // ç»˜åˆ¶é—®é¢˜å•
                ctx.fillStyle = this.type.color;
                ctx.strokeStyle = '#2c2c2c';
                ctx.lineWidth = 2;
                
                const width = 160;
                const height = 100;
                
                ctx.beginPath();
                ctx.roundRect(this.x - width/2, this.y - height/2, width, height, 10);
                ctx.fill();
                ctx.stroke();
                
                // é—®é¢˜è¯¦æƒ…
                ctx.fillStyle = '#fff';
                ctx.font = '12px Microsoft YaHei';
                ctx.textAlign = 'center';
                
                ctx.fillText(`ğŸš¨ ${this.type.name}`, this.x, this.y - 25);
                ctx.fillText(`ä¸¥é‡åº¦: ${'â­'.repeat(this.type.severity)}`, this.x, this.y - 5);
                ctx.fillText(`ç´§æ€¥åº¦: ${this.type.urgency}`, this.x, this.y + 10);
                ctx.fillText(`å®¢æˆ·å½±å“: ${this.type.customerImpact}`, this.x, this.y + 25);
                
                // é—®é¢˜ç¼–å·
                ctx.font = '10px Arial';
                ctx.fillText(`ID: ${this.id}`, this.x, this.y + 40);
                
                // å®¢æˆ·å‚¬ä¿ƒæ¬¡æ•°
                if (this.customerComplaintCount > 0) {
                    ctx.fillStyle = '#e74c3c';
                    ctx.font = '14px Arial';
                    ctx.fillText(`ğŸ˜¡ å®¢æˆ·å‚¬ä¿ƒ ${this.customerComplaintCount} æ¬¡`, this.x, this.y - 45);
                }
                
                ctx.restore();
            }
            
            checkClick(mouseX, mouseY) {
                const width = 160;
                const height = 100;
                return !this.clicked && 
                       mouseX > this.x - width/2 && 
                       mouseX < this.x + width/2 &&
                       mouseY > this.y - height/2 && 
                       mouseY < this.y + height/2;
            }
            
            createGroup() {
                if (this.clicked) return;
                
                this.clicked = true;
                this.status = 'group_created';
                
                // è´¨ç®¡åˆ›å»ºç¾¤èŠ
                gameStats.qualityGroupCreated++;
                qualityScoreElement.textContent = gameStats.qualityGroupCreated;
                
                // åˆ›å»ºç¾¤èŠ
                groupChats.push(new GroupChat(this));
                
                // è´¨ç®¡å°ç‹çš„åŠ¨ä½œ
                characters.qualityManager.isCreatingGroup = true;
                setTimeout(() => {
                    characters.qualityManager.isCreatingGroup = false;
                }, 1000);
                
                // æ˜¾ç¤ºè´¨ç®¡çš„è¯
                showExcuse(characters.qualityManager.x, characters.qualityManager.y - 80, 
                    ["å¤§å®¶å¿«æ¥è§£å†³è¿™ä¸ªè´¨é‡é—®é¢˜ï¼"], '#27ae60');
                
                // ç²’å­æ•ˆæœ
                for (let i = 0; i < 10; i++) {
                    particles.push(new Particle(this.x, this.y, '#27ae60'));
                }
            }
            
            showCustomerComplaint() {
                const complaint = customerAngryComments[Math.floor(Math.random() * customerAngryComments.length)];
                showExcuse(this.x, this.y - 60, [complaint], '#8e44ad');
            }
        }
        
        // ç¾¤èŠç±»
        class GroupChat {
            constructor(issue) {
                this.issue = issue;
                this.x = canvas.width / 2;
                this.y = 200;
                this.width = 300;
                this.height = 150;
                this.life = 5.0; // ç¾¤èŠå­˜åœ¨æ—¶é—´
                this.kangkangInGroup = true;
                this.messages = [
                    "è´¨ç®¡å°ç‹åˆ›å»ºäº†ç¾¤èŠ",
                    "è´¨ç®¡å°ç‹é‚€è¯·äº†åº·åº·è€å¸ˆã€è¿è¥é˜¿æ˜"
                ];
                this.messageTimer = 0;
            }
            
            update() {
                this.life -= 0.01;
                this.messageTimer += 0.02;
                
                // å®šæœŸæ·»åŠ æ¶ˆæ¯
                if (Math.random() < 0.01) {
                    if (this.kangkangInGroup && Math.random() < 0.3) {
                        // åº·åº·å¯èƒ½ä¼šè¯´è¯ï¼ˆç„¶åé€€ç¾¤ï¼‰
                        this.messages.push("åº·åº·è€å¸ˆ: " + kangkangQuitExcuses[Math.floor(Math.random() * kangkangQuitExcuses.length)]);
                        // ç„¶åé€€ç¾¤
                        setTimeout(() => {
                            this.kangkangQuitGroup();
                        }, 1000);
                    } else if (Math.random() < 0.2) {
                        // è¿è¥åæ§½
                        this.messages.push("è¿è¥é˜¿æ˜: " + operationsComplaints[Math.floor(Math.random() * operationsComplaints.length)]);
                    } else if (Math.random() < 0.15) {
                        // è´¨ç®¡æ— è¯­
                        this.messages.push("è´¨ç®¡å°ç‹: " + qualityManagerComplains[Math.floor(Math.random() * qualityManagerComplains.length)]);
                    }
                }
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = Math.min(this.life / 5.0, 1.0);
                
                // ç»˜åˆ¶ç¾¤èŠçª—å£
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#bdc3c7';
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                ctx.roundRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height, 10);
                ctx.fill();
                ctx.stroke();
                
                // ç¾¤èŠæ ‡é¢˜
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 14px Microsoft YaHei';
                ctx.textAlign = 'center';
                ctx.fillText(`ğŸ’¬ è´¨é‡é—®é¢˜å¤„ç†ç¾¤ (${this.issue.id})`, this.x, this.y - this.height/2 + 20);
                
                // æˆå‘˜çŠ¶æ€
                ctx.font = '12px Microsoft YaHei';
                let memberText = "ğŸ‘¥ æˆå‘˜: è´¨ç®¡å°ç‹, ";
                memberText += this.kangkangInGroup ? "åº·åº·è€å¸ˆ, " : "åº·åº·è€å¸ˆ(å·²é€€å‡º), ";
                memberText += "è¿è¥é˜¿æ˜";
                ctx.fillText(memberText, this.x, this.y - this.height/2 + 40);
                
                // æ˜¾ç¤ºæœ€è¿‘çš„æ¶ˆæ¯
                ctx.font = '11px Microsoft YaHei';
                ctx.textAlign = 'left';
                const recentMessages = this.messages.slice(-3);
                for (let i = 0; i < recentMessages.length; i++) {
                    const message = recentMessages[i];
                    if (message.length > 35) {
                        ctx.fillText(message.substring(0, 35) + "...", 
                            this.x - this.width/2 + 10, this.y - 20 + i * 20);
                    } else {
                        ctx.fillText(message, 
                            this.x - this.width/2 + 10, this.y - 20 + i * 20);
                    }
                }
                
                // ç¾¤èŠçŠ¶æ€
                if (!this.kangkangInGroup) {
                    ctx.fillStyle = '#e74c3c';
                    ctx.font = 'bold 12px Microsoft YaHei';
                    ctx.textAlign = 'center';
                    ctx.fillText("âš ï¸ åº·åº·è€å¸ˆå·²é€€å‡ºç¾¤èŠ", this.x, this.y + this.height/2 - 10);
                }
                
                ctx.restore();
            }
            
            kangkangQuitGroup() {
                if (!this.kangkangInGroup) return;
                
                this.kangkangInGroup = false;
                this.messages.push("åº·åº·è€å¸ˆé€€å‡ºäº†ç¾¤èŠ");
                
                // æ›´æ–°ç»Ÿè®¡
                gameStats.procurementQuits++;
                characters.kangkangTeacher.quitCount++;
                procurementScoreElement.textContent = gameStats.procurementQuits;
                
                // è´¨ç®¡æ— è¯­
                gameStats.frustrationLevel++;
                frustrationLevelElement.textContent = gameStats.frustrationLevel;
                
                // åº·åº·é€€ç¾¤åŠ¨ä½œ
                characters.kangkangTeacher.isQuitting = true;
                setTimeout(() => {
                    characters.kangkangTeacher.isQuitting = false;
                }, 1000);
                
                // ç²’å­æ•ˆæœ
                for (let i = 0; i < 8; i++) {
                    particles.push(new Particle(characters.kangkangTeacher.x, characters.kangkangTeacher.y, '#e74c3c'));
                }
            }
        }
        
        // ç²’å­æ•ˆæœç±»
        class Particle {
            constructor(x, y, color = null) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 6;
                this.vy = (Math.random() - 0.5) * 6;
                this.life = 1.0;
                this.decay = Math.random() * 0.02 + 0.01;
                this.color = color || `hsl(${Math.random() * 60 + 15}, 100%, 50%)`;
                this.size = Math.random() * 4 + 2;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                this.vy += 0.1;
                this.vx *= 0.99;
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
        
        // å€Ÿå£æ°”æ³¡ç±»
        class Excuse {
            constructor(x, y, text, color) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.life = 3.0;
                this.vy = -0.8;
                this.color = color;
            }
            
            update() {
                this.y += this.vy;
                this.life -= 0.01;
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = this.life / 3.0;
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                
                const width = Math.max(this.text.length * 8, 100);
                const height = 30;
                
                ctx.beginPath();
                ctx.roundRect(this.x - width/2, this.y - height/2, width, height, 12);
                ctx.fill();
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(this.x - 10, this.y + height/2);
                ctx.lineTo(this.x, this.y + height/2 + 10);
                ctx.lineTo(this.x + 10, this.y + height/2);
                ctx.fill();
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Microsoft YaHei';
                ctx.textAlign = 'center';
                ctx.fillText(this.text, this.x, this.y + 4);
                
                ctx.restore();
            }
        }
        
        // æ˜¾ç¤ºå€Ÿå£
        function showExcuse(x, y, textArray, color) {
            const randomText = textArray[Math.floor(Math.random() * textArray.length)];
            excuses.push(new Excuse(x, y, randomText, color));
        }
        
        // ç»˜åˆ¶è§’è‰²
        function drawCharacter(character, bgColor, emoji) {
            ctx.save();
            ctx.translate(character.x, character.y);
            
            // è§’è‰²èƒŒæ™¯
            ctx.fillStyle = `${bgColor}40`;
            ctx.beginPath();
            ctx.roundRect(-50, -70, 100, 140, 10);
            ctx.fill();
            ctx.strokeStyle = bgColor;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // è§’è‰²æ ‡è¯†
            ctx.fillStyle = bgColor;
            ctx.font = '12px Microsoft YaHei';
            ctx.textAlign = 'center';
            ctx.fillText(`${emoji} ${character.name}`, 0, -80);
            
            // èº«ä½“
            ctx.fillStyle = '#4a90e2';
            ctx.fillRect(-20, -30, 40, 60);
            
            // å¤´éƒ¨
            let faceColor = '#fdbcb4';
            if (character.mood === 'stressed') faceColor = '#ffb3b3';
            else if (character.mood === 'frustrated') faceColor = '#ff9999';
            
            ctx.fillStyle = faceColor;
            ctx.beginPath();
            ctx.arc(0, -45, 20, 0, Math.PI * 2);
            ctx.fill();
            
            // è¡¨æƒ…
            ctx.fillStyle = '#000';
            ctx.beginPath();
            if (character.mood === 'avoidance') {
                // åº·åº·è€å¸ˆçš„å›é¿çœ¼ç¥
                ctx.ellipse(-6, -50, 2, 1, 0, 0, Math.PI * 2);
                ctx.ellipse(6, -50, 2, 1, 0, 0, Math.PI * 2);
            } else {
                ctx.arc(-6, -50, 2, 0, Math.PI * 2);
                ctx.arc(6, -50, 2, 0, Math.PI * 2);
            }
            ctx.fill();
            
            // å˜´å·´
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            if (character.mood === 'stressed' || character.mood === 'frustrated') {
                ctx.arc(0, -38, 5, Math.PI, 0); // æ„çœ‰è‹¦è„¸
            } else if (character.mood === 'avoidance') {
                ctx.moveTo(-4, -38);
                ctx.lineTo(4, -38); // ç´§é—­å˜´å·´
            }
            ctx.stroke();
            
            // æ‰‹è‡‚åŠ¨ä½œ
            ctx.strokeStyle = faceColor;
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            
            if (character.isCreatingGroup) {
                // åˆ›å»ºç¾¤èŠæ‰‹åŠ¿
                ctx.save();
                ctx.rotate(0.5);
                ctx.beginPath();
                ctx.moveTo(-20, -15);
                ctx.lineTo(-35, -25);
                ctx.stroke();
                ctx.restore();
            } else if (character.isQuitting) {
                // é€€ç¾¤æ‰‹åŠ¿
                ctx.save();
                ctx.rotate(-0.8);
                ctx.beginPath();
                ctx.moveTo(20, -15);
                ctx.lineTo(40, -10);
                ctx.stroke();
                ctx.restore();
            } else if (character.isComplaining) {
                // åæ§½æ‰‹åŠ¿
                ctx.save();
                ctx.rotate(character.armAngle);
                ctx.beginPath();
                ctx.moveTo(-20, -15);
                ctx.lineTo(-40, -20);
                ctx.stroke();
                ctx.restore();
            } else {
                // æ­£å¸¸æ‰‹åŠ¿
                ctx.save();
                ctx.rotate(character.armAngle);
                ctx.beginPath();
                ctx.moveTo(-20, -15);
                ctx.lineTo(-35, -20);
                ctx.moveTo(20, -15);
                ctx.lineTo(35, -20);
                ctx.stroke();
                ctx.restore();
            }
            
            // ç‰¹æ®ŠçŠ¶æ€æ˜¾ç¤º
            if (character.name === 'åº·åº·è€å¸ˆ' && character.quitCount > 0) {
                ctx.fillStyle = '#e74c3c';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`é€€ç¾¤ ${character.quitCount} æ¬¡`, 0, 50);
            }
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶åŠå…¬å®¤èƒŒæ™¯
        function drawOfficeBackground() {
            // åŠå…¬å®¤åœ°é¢
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, '#e8f5e8');
            gradient.addColorStop(0.33, '#f0f0f0');
            gradient.addColorStop(0.66, '#f0f0f0');
            gradient.addColorStop(1, '#e8f5e8');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // éƒ¨é—¨åˆ†åŒºçº¿
            ctx.strokeStyle = '#bdc3c7';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(300, 0);
            ctx.lineTo(300, canvas.height);
            ctx.moveTo(600, 0);
            ctx.lineTo(600, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // éƒ¨é—¨æ ‡è¯†
            ctx.fillStyle = '#27ae60';
            ctx.beginPath();
            ctx.roundRect(50, 30, 200, 40, 8);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '16px Microsoft YaHei';
            ctx.textAlign = 'center';
            ctx.fillText('ğŸ” è´¨é‡ç®¡ç†éƒ¨', 150, 55);
            
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.roundRect(350, 30, 200, 40, 8);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.fillText('ğŸ›’ é‡‡è´­éƒ¨', 450, 55);
            
            ctx.fillStyle = '#3498db';
            ctx.beginPath();
            ctx.roundRect(650, 30, 200, 40, 8);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.fillText('ğŸ“Š è¿è¥éƒ¨', 750, 55);
            
            // æµç¨‹çŠ¶æ€æ˜¾ç¤º
            ctx.fillStyle = '#2c3e50';
            ctx.font = '18px Microsoft YaHei';
            ctx.textAlign = 'center';
            ctx.fillText('è´¨é‡é—®é¢˜å¤„ç†æµç¨‹çŠ¶æ€', canvas.width / 2, 120);
            
            // æµç¨‹æ­¥éª¤
            const steps = [
                { name: 'å‘ç°é—®é¢˜', status: 'done', color: '#27ae60' },
                { name: 'æ‹‰ç¾¤åè°ƒ', status: gameStats.qualityGroupCreated > 0 ? 'done' : 'pending', color: '#f39c12' },
                { name: 'è´£ä»»ç¡®è®¤', status: 'stuck', color: '#e74c3c' },
                { name: 'é—®é¢˜è§£å†³', status: 'pending', color: '#95a5a6' },
                { name: 'å®¢æˆ·åé¦ˆ', status: 'pending', color: '#95a5a6' }
            ];
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                const x = 180 + i * 140;
                const y = 150;
                
                ctx.fillStyle = step.color;
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText((i + 1).toString(), x, y + 4);
                
                ctx.fillStyle = '#2c3e50';
                ctx.font = '12px Microsoft YaHei';
                ctx.fillText(step.name, x, y + 35);
                
                if (step.status === 'stuck') {
                    ctx.fillStyle = '#e74c3c';
                    ctx.fillText('å¡ä½äº†ï¼', x, y + 50);
                }
                
                // è¿æ¥çº¿
                if (i < steps.length - 1) {
                    ctx.strokeStyle = '#bdc3c7';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x + 15, y);
                    ctx.lineTo(x + 125, y);
                    ctx.stroke();
                }
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            for (let i = 0; i < 3; i++) {
                qualityIssues.push(new QualityIssue());
                qualityIssues[i].y = i * -200;
            }
        }
        
        // åˆ›å»ºç´§æ€¥è´¨é‡é—®é¢˜
        function createEmergencyIssue() {
            const urgentIssue = new QualityIssue();
            urgentIssue.type = qualityIssueTypes.find(type => type.severity >= 4) || qualityIssueTypes[1];
            urgentIssue.y = -50;
            urgentIssue.customerComplaintCount = Math.floor(Math.random() * 3) + 1;
            qualityIssues.push(urgentIssue);
            
            // ç«‹å³è§¦å‘å®¢æˆ·å‹åŠ›
            gameStats.customerPressure += 2;
            gameStats.customerAnger += 3;
            customerPressureElement.textContent = gameStats.customerPressure;
            customerAngerElement.textContent = gameStats.customerAnger;
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawOfficeBackground();
            
            // æ›´æ–°å’Œç»˜åˆ¶è´¨é‡é—®é¢˜
            qualityIssues.forEach(issue => {
                issue.update();
                issue.draw();
            });
            
            // æ›´æ–°å’Œç»˜åˆ¶ç¾¤èŠ
            groupChats = groupChats.filter(chat => {
                chat.update();
                chat.draw();
                return chat.life > 0;
            });
            
            // æ›´æ–°è§’è‰²åŠ¨ä½œ
            Object.values(characters).forEach(char => {
                char.armAngle = Math.sin(Date.now() * 0.003) * 0.2;
            });
            
            // ç»˜åˆ¶è§’è‰²
            drawCharacter(characters.qualityManager, '#27ae60', 'ğŸ”');
            drawCharacter(characters.kangkangTeacher, '#e74c3c', 'ğŸ›’');
            drawCharacter(characters.operationsManager, '#3498db', 'ğŸ“Š');
            
            // æ›´æ–°ç²’å­æ•ˆæœ
            particles = particles.filter(particle => {
                particle.update();
                particle.draw();
                return particle.life > 0;
            });
            
            // æ›´æ–°å€Ÿå£æ°”æ³¡
            excuses = excuses.filter(excuse => {
                excuse.update();
                excuse.draw();
                return excuse.life > 0;
            });
            
            requestAnimationFrame(gameLoop);
        }
        
        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»è´¨é‡é—®é¢˜
            qualityIssues.forEach(issue => {
                if (issue.checkClick(x, y)) {
                    issue.createGroup();
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åº·åº·è€å¸ˆ
            const kk = characters.kangkangTeacher;
            if (Math.sqrt((x - kk.x) ** 2 + (y - kk.y) ** 2) < 50) {
                // è®©åº·åº·è€å¸ˆé€€ç¾¤
                groupChats.forEach(chat => {
                    if (chat.kangkangInGroup) {
                        chat.kangkangQuitGroup();
                    }
                });
            }
        });
        
        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                // è¿è¥éƒ¨åæ§½
                gameStats.operationsComplaints++;
                operationsComplaintElement.textContent = gameStats.operationsComplaints;
                
                characters.operationsManager.isComplaining = true;
                setTimeout(() => {
                    characters.operationsManager.isComplaining = false;
                }, 800);
                
                showExcuse(characters.operationsManager.x, characters.operationsManager.y - 80, 
                    operationsComplaints, '#3498db');
                
                for (let i = 0; i < 5; i++) {
                    particles.push(new Particle(characters.operationsManager.x, 
                        characters.operationsManager.y, '#3498db'));
                }
            } else if (e.code === 'KeyR') {
                e.preventDefault();
                // é‡‡è´­ç”©é”…
                gameStats.procurementDodge++;
                procurementDodgeElement.textContent = gameStats.procurementDodge;
                
                showExcuse(characters.kangkangTeacher.x, characters.kangkangTeacher.y - 80, 
                    procurementDodgeExcuses, '#e74c3c');
                
                for (let i = 0; i < 5; i++) {
                    particles.push(new Particle(characters.kangkangTeacher.x, 
                        characters.kangkangTeacher.y, '#e74c3c'));
                }
            }
        });
        
        // CanvasRenderingContext2D.roundRect polyfill
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y);
                this.lineTo(x + width - radius, y);
                this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius);
                this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height);
                this.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y);
                this.closePath();
            };
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
        gameLoop();
        
        // æ¸¸æˆè¯´æ˜
        setTimeout(() => {
            alert('ğŸ”¥ è´¨é‡é—®é¢˜è¸¢çš®çƒå¤§ä½œæˆ˜æ¸¸æˆè¯´æ˜ï¼š\n\n' +
                  'ğŸ“‹ åœºæ™¯ï¼šå®¢æˆ·ä¸‹å•åå‘ç°è´¨é‡é—®é¢˜ï¼Œéœ€è¦ä¸‰ä¸ªéƒ¨é—¨åè°ƒå¤„ç†\n\n' +
                  'ğŸ® æ“ä½œè¯´æ˜ï¼š\n' +
                  'â€¢ ç‚¹å‡»è´¨é‡é—®é¢˜å• â†’ è´¨ç®¡å°ç‹æ‹‰ç¾¤åè°ƒ\n' +
                  'â€¢ ç‚¹å‡»åº·åº·è€å¸ˆ â†’ åº·åº·è€å¸ˆé€€ç¾¤è·‘è·¯\n' +
                  'â€¢ æŒ‰ç©ºæ ¼é”® â†’ è¿è¥é˜¿æ˜åæ§½\n' +
                  'â€¢ æŒ‰Ré”® â†’ é‡‡è´­éƒ¨ç”©é”…\n' +
                  'â€¢ å³ä¸Šè§’æŒ‰é’® â†’ åˆ›å»ºç´§æ€¥è´¨é‡é—®é¢˜\n\n' +
                  'ğŸ˜‚ ç»å…¸åœºæ™¯è¿˜åŸï¼š\n' +
                  'â€¢ åº·åº·è€å¸ˆå„ç§å€Ÿå£é€€ç¾¤ï¼š"æˆ‘å¦ˆå–Šæˆ‘åƒé¥­"\n' +
                  'â€¢ è¿è¥éƒ¨ç–¯ç‹‚åæ§½ï¼š"åˆæ˜¯é‡‡è´­çš„é”…ï¼"\n' +
                  'â€¢ è´¨ç®¡å°ç‹æ— è¯­ï¼š"æˆ‘å·²ç»æ‹‰ç¾¤ä¸‰æ¬¡äº†ï¼"\n' +
                  'â€¢ å®¢æˆ·è¶Šæ¥è¶Šæ„¤æ€’ï¼š"ä»€ä¹ˆæ—¶å€™èƒ½è§£å†³ï¼Ÿï¼"\n\n' +
                  'ğŸ¯ ç°å®å†™ç…§ï¼šé—®é¢˜æ°¸è¿œè§£å†³ä¸äº†ï¼Œ\nä½†ç”©é”…æŠ€èƒ½å¯ä»¥æ— é™å‡çº§ï¼ğŸ’€');
        }, 1000);
    </script>
</body>
</html>