<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∫∑Â∫∑Áî©ÈîÖÂàáÂàáÂàá PRO - ËçØÂ∏àÂ∏ÆOAÁªàÊûÅÂ§ß‰π±Êñó</title>
    
    <!-- ÂºïÂÖ•Ê∏∏ÊàèÂºÄÂèëÂ∫ì -->
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'Orbitron', sans-serif;
            background: #000;
            overflow: hidden;
            user-select: none;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Âä®ÊÄÅÁ≤íÂ≠êËÉåÊôØ */
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* ÁôªÂΩïÁïåÈù¢ */
        .login-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(26,35,126,0.9) 0%, rgba(0,0,0,0.95) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            cursor: default;
        }

        .login-box {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.2);
            padding: 60px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 
                0 25px 80px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.2);
            animation: loginPulse 3s ease-in-out infinite;
        }

        @keyframes loginPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 25px 80px rgba(102,126,234,0.3); }
            50% { transform: scale(1.02); box-shadow: 0 30px 100px rgba(102,126,234,0.5); }
        }

        .login-box h1 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 48px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 
                0 0 20px rgba(102,126,234,0.8),
                0 0 40px rgba(102,126,234,0.6),
                0 0 60px rgba(102,126,234,0.4);
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 0 20px rgba(102,126,234,0.8), 0 0 40px rgba(102,126,234,0.6); }
            to { text-shadow: 0 0 30px rgba(255,107,107,0.8), 0 0 60px rgba(255,107,107,0.6); }
        }

        .login-box h2 {
            color: rgba(255,255,255,0.8);
            margin-bottom: 40px;
            font-size: 20px;
            font-weight: 400;
        }

        .login-box input {
            padding: 20px 25px;
            width: 400px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            font-size: 20px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: text;
        }

        .login-box input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .login-box input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 30px rgba(102,126,234,0.5);
            transform: scale(1.02);
        }

        .start-button {
            padding: 20px 50px;
            background: linear-gradient(45deg, #667eea, #764ba2, #ff6b6b);
            background-size: 300% 300%;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 35px rgba(102,126,234,0.4);
            animation: buttonShine 3s ease-in-out infinite;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        @keyframes buttonShine {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .start-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 50px rgba(102,126,234,0.6);
        }

        /* Ê∏∏ÊàèÁïåÈù¢ */
        .game-screen {
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 10;
        }

        /* Ê∏∏ÊàèÂÆπÂô® */
        #gameContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Â∫∑Â∫∑ËßíËâ≤ÈáçÊñ∞ËÆæËÆ° */
        .kangkang-character {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 220px;
            height: 280px;
            z-index: 50;
            pointer-events: none;
        }

        .character-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* ‰∫∫Áâ©‰∏ª‰Ωì */
        .kangkang-figure {
            width: 180px;
            height: 220px;
            position: relative;
            margin: 0 auto;
            animation: figureBreathing 3s ease-in-out infinite;
        }

        @keyframes figureBreathing {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-12px) scale(1.03); }
        }

        /* Â§¥ÈÉ®ËÆæËÆ° */
        .kangkang-head {
            width: 110px;
            height: 110px;
            position: absolute;
            top: 0;
            left: 35px;
            background: radial-gradient(circle at 35% 30%, #ffdbcf, #f7a999, #e89585);
            border-radius: 50%;
            border: 4px solid #2c3e50;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.3),
                inset 0 5px 15px rgba(255,255,255,0.2);
            z-index: 20;
        }

        /* ÂèëÂûã */
        .kangkang-hair {
            position: absolute;
            top: -8px;
            left: 15px;
            width: 80px;
            height: 50px;
            background: linear-gradient(145deg, #2c3e50, #34495e, #455a75);
            border-radius: 80px 80px 20px 20px;
            border: 3px solid #1a252f;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        .hair-strand {
            position: absolute;
            width: 15px;
            height: 25px;
            background: linear-gradient(145deg, #34495e, #455a75);
            border-radius: 50% 50% 20px 20px;
            border: 2px solid #1a252f;
        }

        .hair-strand:nth-child(1) { top: -5px; left: -8px; transform: rotate(-15deg); }
        .hair-strand:nth-child(2) { top: -3px; right: -5px; transform: rotate(10deg); }

        /* ËÑ∏ÈÉ®ÁâπÂæÅ */
        .kangkang-face {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
        }

        .face-expression {
            font-size: 45px;
            text-align: center;
            line-height: 60px;
            animation: faceChanging 4s ease-in-out infinite;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        @keyframes faceChanging {
            0%, 25% { transform: scale(1); content: 'üò§'; }
            30%, 50% { transform: scale(1.1); content: 'üò†'; }
            55%, 75% { transform: scale(1.05); content: 'ü§¨'; }
            80%, 100% { transform: scale(1.15); content: 'üòà'; }
        }

        /* ÁúºÁùõ */
        .eye {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #2c3e50;
            border-radius: 50%;
            animation: eyeBlink 3s ease-in-out infinite;
        }

        .eye.left { top: 20px; left: 20px; }
        .eye.right { top: 20px; right: 20px; }

        @keyframes eyeBlink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        /* Âò¥Â∑¥ */
        .mouth {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 12px;
            border: 3px solid #2c3e50;
            border-top: none;
            border-radius: 0 0 20px 20px;
            animation: mouthTalk 2s ease-in-out infinite;
        }

        @keyframes mouthTalk {
            0%, 50%, 100% { transform: translateX(-50%) scaleY(1); }
            25%, 75% { transform: translateX(-50%) scaleY(1.5); }
        }

        /* Ë∫´‰ΩìËÆæËÆ° */
        .kangkang-body {
            width: 140px;
            height: 160px;
            position: absolute;
            top: 80px;
            left: 20px;
            background: linear-gradient(145deg, #ff6b6b, #ee5a24, #d63031);
            border-radius: 70px 70px 40px 40px;
            border: 4px solid #2c3e50;
            box-shadow: 
                0 15px 35px rgba(255,107,107,0.4),
                inset 0 8px 20px rgba(255,255,255,0.2);
        }

        /* Ë°£ÊúçÁªÜËäÇ */
        .shirt-detail {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 120px;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 50px 50px 20px 20px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* Á∫ΩÊâ£ */
        .button {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #f1c40f;
            border-radius: 50%;
            border: 2px solid #2c3e50;
            left: 50%;
            transform: translateX(-50%);
        }

        .button:nth-child(1) { top: 30px; }
        .button:nth-child(2) { top: 50px; }
        .button:nth-child(3) { top: 70px; }

        /* ÊâãËáÇËÆæËÆ° */
        .kangkang-arm {
            width: 70px;
            height: 30px;
            position: absolute;
            background: linear-gradient(45deg, #ffdbcf, #f7a999);
            border-radius: 25px;
            border: 3px solid #2c3e50;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            transform-origin: left center;
        }

        .arm-left {
            top: 100px;
            left: -50px;
            animation: armSwing 2s ease-in-out infinite;
        }

        .arm-right {
            top: 100px;
            right: -50px;
            animation: armThrowMotion 1.2s ease-in-out infinite;
        }

        @keyframes armSwing {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
        }

        @keyframes armThrowMotion {
            0% { transform: rotate(0deg) scale(1); }
            20% { transform: rotate(-20deg) scale(1.05); }
            40% { transform: rotate(-50deg) scale(1.1); }
            60% { transform: rotate(-80deg) scale(1.15); }
            80% { transform: rotate(-60deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        /* ÊâãÈÉ® */
        .hand {
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, #ffdbcf, #f7a999);
            border-radius: 50%;
            border: 2px solid #2c3e50;
            right: -12px;
            top: 2px;
        }

        /* ËÖøÈÉ® */
        .kangkang-legs {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 60px;
        }

        .leg {
            width: 30px;
            height: 50px;
            background: linear-gradient(145deg, #2c3e50, #34495e);
            border-radius: 20px;
            border: 3px solid #1a252f;
            position: absolute;
            bottom: 0;
        }

        .leg.left {
            left: 10px;
            animation: legWalk 2s ease-in-out infinite;
        }

        .leg.right {
            right: 10px;
            animation: legWalk 2s ease-in-out infinite 1s;
        }

        @keyframes legWalk {
            0%, 50%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }

        /* ÈûãÂ≠ê */
        .shoe {
            position: absolute;
            bottom: -8px;
            width: 35px;
            height: 15px;
            background: #1a252f;
            border-radius: 20px 5px 5px 20px;
            border: 2px solid #0f1419;
        }

        /* ‰∫∫Áâ©ÂêçÂ≠óÔºàÊîæÂú®‰∏ãÊñπÔºâ */
        .character-name {
            position: absolute;
            bottom: -40px;
            left: 0;
            right: 0;
            text-align: center;
            color: #fff;
            font-weight: 900;
            font-size: 22px;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(102,126,234,0.5);
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            border: 3px solid rgba(255,255,255,0.3);
            animation: nameGlow 3s ease-in-out infinite;
        }

        @keyframes nameGlow {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(102,126,234,0.5);
                text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(255,107,107,0.6);
                text-shadow: 0 0 15px rgba(255,107,107,0.8);
            }
        }

        /* ÂØπËØùÊ≥°Ê≥°ÂçáÁ∫ßÁâàÔºàÊó∂Èó¥Âª∂ÈïøÔºâ */
        .speech-bubble {
            position: absolute;
            bottom: 320px;
            left: 20px;
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(248,248,248,0.95));
            backdrop-filter: blur(15px);
            padding: 25px 30px;
            border-radius: 30px;
            border: 4px solid rgba(255,107,107,0.7);
            font-size: 18px;
            font-weight: 700;
            color: #333;
            max-width: 320px;
            min-height: 60px;
            animation: bubbleAnimationLong 8s ease-in-out;
            z-index: 60;
            box-shadow: 
                0 15px 40px rgba(255,107,107,0.4),
                inset 0 2px 0 rgba(255,255,255,0.9);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -25px;
            left: 60px;
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 25px solid rgba(255,255,255,0.98);
        }

        @keyframes bubbleAnimationLong {
            0% { opacity: 0; transform: scale(0) rotate(-20deg); }
            8% { opacity: 1; transform: scale(1.1) rotate(3deg); }
            12% { transform: scale(1) rotate(0deg); }
            88% { opacity: 1; transform: scale(1) rotate(0deg); }
            100% { opacity: 0; transform: scale(0.7) rotate(20deg); }
        }

        /* Áé∞‰ª£ÂåñUIÈù¢Êùø */
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .hud-panel {
            position: absolute;
            top: 30px;
            left: 30px;
            background: linear-gradient(145deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            padding: 25px 35px;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        }

        .hud-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .hud-icon {
            margin-right: 15px;
            font-size: 28px;
        }

        .hud-value {
            color: #667eea;
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 10px rgba(102,126,234,0.8);
        }

        .time-value {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255,107,107,0.8);
            animation: timePulse 1s ease-in-out infinite;
        }

        @keyframes timePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ÊäÄËÉΩÁ≥ªÁªüUI */
        .skills-panel {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .skill-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(145deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9));
            border: 3px solid rgba(255,255,255,0.3);
            color: #fff;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
            backdrop-filter: blur(10px);
        }

        .skill-button:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 15px 40px rgba(102,126,234,0.6);
        }

        .skill-button.cooldown {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ÊéíË°åÊ¶úÂçáÁ∫ßÁâà */
        .leaderboard {
            position: absolute;
            top: 30px;
            right: 30px;
            background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.2);
            padding: 30px;
            border-radius: 25px;
            width: 320px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            pointer-events: auto;
            cursor: default;
        }

        .leaderboard h3 {
            text-align: center;
            color: #fff;
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            text-shadow: 0 0 15px rgba(102,126,234,0.8);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 15px;
            font-size: 18px;
            color: #fff;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .leaderboard-item:hover {
            transform: translateX(8px);
            background: linear-gradient(145deg, rgba(102,126,234,0.3), rgba(102,126,234,0.1));
            box-shadow: 0 5px 20px rgba(102,126,234,0.3);
        }

        .leaderboard-item.top3 {
            background: linear-gradient(45deg, rgba(255,215,0,0.8), rgba(255,237,78,0.6));
            color: #333;
            font-weight: 900;
            box-shadow: 0 8px 25px rgba(255,215,0,0.4);
            border: 2px solid rgba(255,215,0,0.8);
        }

        /* Ê∏∏ÊàèÁªìÊùüÁïåÈù¢ÂçáÁ∫ß */
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.98) 100%);
            backdrop-filter: blur(20px);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
            cursor: default;
        }

        .game-over-box {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(30px);
            border: 3px solid rgba(255,255,255,0.2);
            padding: 60px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 30px 100px rgba(0,0,0,0.8);
            animation: gameOverPulse 2s ease-in-out infinite;
        }

        @keyframes gameOverPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .game-over-box h2 {
            color: #fff;
            margin-bottom: 30px;
            font-size: 48px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 30px rgba(255,107,107,0.8);
        }

        .game-over-box p {
            color: rgba(255,255,255,0.9);
            margin-bottom: 40px;
            font-size: 24px;
            font-weight: 600;
        }

        .game-over-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .game-over-button {
            padding: 20px 40px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .game-over-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(102,126,234,0.6);
        }

        .game-over-button.secondary {
            background: linear-gradient(45deg, #666, #888);
        }

        /* ÁâπÊïàÂíåÂä®Áîª */
        .hidden {
            display: none !important;
        }

        .combo-effect {
            position: absolute;
            font-size: 64px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            color: #fff;
            text-shadow: 
                0 0 20px rgba(255,107,107,0.8),
                0 0 40px rgba(255,107,107,0.6),
                0 0 60px rgba(255,107,107,0.4);
            z-index: 200;
            pointer-events: none;
        }

        .slice-complaint-pro {
            position: absolute;
            background: linear-gradient(45deg, rgba(255,107,107,0.9), rgba(255,142,142,0.8));
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(255,107,107,0.5);
            z-index: 150;
            pointer-events: none;
            border: 2px solid rgba(255,255,255,0.4);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .login-box { padding: 40px; width: 90%; }
            .login-box input { width: 100%; }
            .kangkang-character { width: 180px; height: 240px; bottom: 20px; left: 20px; }
            .leaderboard { width: 280px; top: 20px; right: 20px; }
            .hud-panel { top: 20px; left: 20px; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Âä®ÊÄÅÁ≤íÂ≠êËÉåÊôØ -->
        <div id="particles-js"></div>

        <!-- ÁôªÂΩïÁïåÈù¢ -->
        <div class="login-screen" id="loginScreen">
            <div class="login-box">
                <h1>üî™ Â∫∑Â∫∑Áî©ÈîÖÂàáÂàáÂàá PRO ü•ò</h1>
                <h2>ËçØÂ∏àÂ∏ÆOAÁªàÊûÅÂ§ß‰π±Êñó - ÈÄÄÁæ§‰º†ËØ¥ÈáçÂà∂Áâà</h2>
                <input type="text" id="nicknameInput" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊàòÊñóÊòµÁß∞" maxlength="20">
                <br>
                <button class="start-button" onclick="startGame()">‚ö° ÂºÄÂßãÁî©ÈîÖÂ§ßÊàò ‚ö°</button>
            </div>
        </div>

        <!-- Ê∏∏ÊàèÁïåÈù¢ -->
        <div class="game-screen hidden" id="gameScreen">
            <!-- KonvaÊ∏∏ÊàèÂÆπÂô® -->
            <div id="gameContainer"></div>
            
            <!-- Â∫∑Â∫∑ËßíËâ≤ÈáçÊñ∞ËÆæËÆ° -->
            <div class="kangkang-character" id="kangkangCharacter">
                <div class="character-container">
                    <div class="kangkang-figure">
                        <!-- Â§¥ÈÉ® -->
                        <div class="kangkang-head">
                            <div class="kangkang-hair">
                                <div class="hair-strand"></div>
                                <div class="hair-strand"></div>
                            </div>
                            <div class="kangkang-face">
                                <div class="eye left"></div>
                                <div class="eye right"></div>
                                <div class="face-expression">üò§</div>
                                <div class="mouth"></div>
                            </div>
                        </div>
                        
                        <!-- Ë∫´‰Ωì -->
                        <div class="kangkang-body">
                            <div class="shirt-detail">
                                <div class="button"></div>
                                <div class="button"></div>
                                <div class="button"></div>
                            </div>
                        </div>
                        
                        <!-- ÊâãËáÇ -->
                        <div class="kangkang-arm arm-left">
                            <div class="hand"></div>
                        </div>
                        <div class="kangkang-arm arm-right">
                            <div class="hand"></div>
                        </div>
                        
                        <!-- ËÖøÈÉ® -->
                        <div class="kangkang-legs">
                            <div class="leg left">
                                <div class="shoe"></div>
                            </div>
                            <div class="leg right">
                                <div class="shoe"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‰∫∫Áâ©ÂêçÂ≠óÔºàÊîæÂú®‰∏ãÊñπÔºâ -->
                    <div class="character-name">‚ö° È¶ñÊé®Â∫∑Â∫∑ ‚ö°</div>
                </div>
            </div>

            <!-- ÂØπËØùÊ≥°Ê≥° -->
            <div class="speech-bubble hidden" id="speechBubble"></div>

            <!-- Áé∞‰ª£ÂåñÊ∏∏ÊàèUI -->
            <div class="game-ui">
                <!-- HUDÈù¢Êùø -->
                <div class="hud-panel">
                    <div class="hud-item">
                        <span class="hud-icon">‚ö°</span>
                        <span>ÂæóÂàÜ: <span class="hud-value" id="score">0</span></span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-icon">üî•</span>
                        <span>ËøûÂáª: <span class="hud-value" id="combo">0</span></span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-icon">‚è∞</span>
                        <span>Êó∂Èó¥: <span class="time-value" id="time">60</span>s</span>
                    </div>
                </div>

                <!-- ÊäÄËÉΩÈù¢Êùø -->
                <div class="skills-panel">
                    <button class="skill-button" id="slowTimeSkill" title="Êó∂Èó¥ÂáèÁºì">‚è±Ô∏è</button>
                    <button class="skill-button" id="multiSliceSkill" title="Â§öÈáçÂàáÂâ≤">‚öîÔ∏è</button>
                    <button class="skill-button" id="scoreBonusSkill" title="ÂàÜÊï∞Âä†Êàê">üíé</button>
                </div>

                <!-- ÊéíË°åÊ¶ú -->
                <div class="leaderboard" id="leaderboard">
                    <h3>üèÜ ÂàáÈîÖÊéíË°åÊ¶ú TOP 10</h3>
                    <div id="leaderboardContent">
                        <!-- ÊéíË°åÊ¶úÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê∏∏ÊàèÁªìÊùüÁïåÈù¢ -->
        <div class="game-over" id="gameOver">
            <div class="game-over-box">
                <h2 id="gameOverTitle">üéÆ Ê∏∏ÊàèÁªìÊùü!</h2>
                <p id="gameOverScore">ÊÇ®ÁöÑÂæóÂàÜ: 0</p>
                <p id="gameOverRank"></p>
                <div class="game-over-buttons">
                    <button class="game-over-button" onclick="restartGame()">üîÑ ÂÜçÊàò‰∏ÄËΩÆ</button>
                    <button class="game-over-button secondary" onclick="backToLogin()">üè† ËøîÂõû‰∏ªÈ°µ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // FirebaseÈÖçÁΩÆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3ioWABsutPeZ9LboagtxLLgo2kyi9Xnw",
            authDomain: "zhuye-fb0a6.firebaseapp.com",
            databaseURL: "https://zhuye-fb0a6-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "zhuye-fb0a6",
            storageBucket: "zhuye-fb0a6.firebasestorage.app",
            messagingSenderId: "5341756226",
            appId: "1:5341756226:web:1df340a043774db92326db",
            measurementId: "G-BG1920BDX0"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ÁÆÄÂåñÈü≥ÊïàÁ≥ªÁªü - ‰ΩøÁî®Web Audio APIÂàõÂª∫Èü≥Êïà
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        const soundSystem = {
            playSlice: () => {
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•Ôºå‰ΩÜ‰∏çÂΩ±ÂìçÊ∏∏Êàè');
                }
            },
            
            playCombo: () => {
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (e) {
                    console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•Ôºå‰ΩÜ‰∏çÂΩ±ÂìçÊ∏∏Êàè');
                }
            },
            
            playThrow: () => {
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(100, audioContext.currentTime + 0.3);
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•Ôºå‰ΩÜ‰∏çÂΩ±ÂìçÊ∏∏Êàè');
                }
            }
        };

        // Ê∏∏ÊàèÂºïÊìéÂàùÂßãÂåñ
        let gameEngine = {
            stage: null,
            layer: null,
            particleLayer: null,
            effectLayer: null,
            width: 0,
            height: 0,
            running: false
        };

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            player: '',
            score: 0,
            combo: 0,
            maxCombo: 0,
            timeLeft: 60,
            level: 1,
            spawnRate: 1000,
            pans: [],
            particles: [],
            skills: {
                slowTime: { cooldown: 0, duration: 0 },
                multiSlice: { cooldown: 0, duration: 0 },
                scoreBonus: { cooldown: 0, duration: 0 }
            }
        };

        // Ê∏∏ÊàèËÆ°Êó∂Âô®
        let gameTimer = null;
        let spawnTimer = null;

        // Âπ≥Â∫ïÈîÖÁ±ªÂûãÂÆö‰πâÔºàÂçáÁ∫ßÁâà - Ê∑ªÂä†ÈÄüÂ∫¶ÂàÜÁ∫ßÔºâ
        const panTypes = {
            oa_process: {
                name: 'OAÊµÅÁ®ãÈîÖ',
                color: '#ff6b6b',
                basePoints: 100,
                size: 70,
                speedRange: [0.8, 1.2],
                complaints: [
                    'Ëøô‰∏™OAÊµÅÁ®ãÂ§™Â§çÊùÇ‰∫ÜÔºÅ', 'Ë∞ÅËÆæËÆ°ÁöÑÁ†¥ÊµÅÁ®ãÔºÅ', 'Êàë‰∏çÁÆ°ÔºåÂ∞èÊ¨ß‰Ω†Êù•ÔºÅ', 'ÊµÅÁ®ãËµ∞‰∏çÈÄöÂïäÔºÅ',
                    'Á≥ªÁªüÂèàÂç°‰∫ÜÔºÅ', 'Ëøô‰∏™ÂÆ°ÊâπË¶ÅÁ≠âÂà∞‰ªÄ‰πàÊó∂ÂÄôÔºÅ', 'ÊµÅÁ®ãËÆæËÆ°ÊúâÈóÆÈ¢òÔºÅ', 'Êàë‰∏ç‰ºöÊìç‰ΩúËøô‰∏™ÔºÅ',
                    '‰∏∫‰ªÄ‰πàË¶ÅËøô‰πàÂ§öÊ≠•È™§ÔºÅ', 'ÊµÅÁ®ãÂ§™ÁπÅÁêê‰∫ÜÔºÅ', 'Ëøô‰∏™Ë¥£‰ªª‰∏çÂú®ÊàëÔºÅ', 'Á≥ªÁªüBUG‰∏çÂÖ≥Êàë‰∫ãÔºÅ',
                    'ËøêËê•ÈÉ®Èó®ÁöÑ‰∫ãÔºÅ', 'Ëøô‰∏™ÈîÖÊàë‰∏çËÉåÔºÅ', 'ÊâæITÈÉ®Èó®ÂéªÔºÅ', 'Ë∞ÅËßÑÂÆöÁöÑËøô‰∏™ÊµÅÁ®ãÔºÅ'
                ],
                emoji: 'üìã'
            },
            customer_service: {
                name: 'ÂÆ¢ÊúçÁî©ÈîÖ',
                color: '#4834d4',
                basePoints: 150,
                size: 75,
                speedRange: [1.0, 1.5],
                complaints: [
                    'ÂÆ¢Êà∑ÁöÑ‰∫ãËøêËê•ÁÆ°ÔºÅ', '‰∏çÊòØÊàëË¥üË¥£ÁöÑÔºÅ', 'ÊâæÂ∫∑Â∫∑ÂéªÔºÅ', 'Ëøô‰∏™Êàë‰∏çÂ§ÑÁêÜÔºÅ',
                    'ÂÆ¢Êà∑Â§™Èöæ‰º∫ÂÄô‰∫ÜÔºÅ', 'Ëøô‰∏™ÈóÆÈ¢òÂæàÂ§çÊùÇÔºÅ', '‰∏çÂú®ÊàëÁöÑËÅåË¥£ËåÉÂõ¥ÔºÅ', 'ÊàëÂè™ÊòØ‰º†ËææÊ∂àÊÅØÔºÅ',
                    'ÂÆ¢Êà∑Ëá™Â∑±ÁöÑÈóÆÈ¢òÔºÅ', 'Ëøô‰∏™Ë¶ÅÈóÆ‰∏äÁ∫ßÔºÅ', 'ÊàëÊ≤°ÊùÉÈôêÂ§ÑÁêÜÔºÅ', 'ÂÆ¢Êà∑ÁêÜËß£Èîô‰∫ÜÔºÅ',
                    'Ëøô‰∏™ÈúÄË¶ÅÊäÄÊúØÊîØÊåÅÔºÅ', '‰∏çÊòØÊúçÂä°ÈóÆÈ¢òÔºÅ', 'ÂÆ¢Êà∑Ë¶ÅÊ±ÇÂ§™Â•áÊÄ™ÔºÅ', 'ÊàëËß£Èáä‰∏çÊ∏ÖÊ•öÔºÅ',
                    'ËÆ©ÂÆ¢Êà∑ÊâæÁõ∏ÂÖ≥ÈÉ®Èó®ÔºÅ', 'Ëøô‰∏™ÊàëÁÆ°‰∏ç‰∫ÜÔºÅ', 'ÂÆ¢Êà∑Ê≤°ÊúâËØ¥Ê∏ÖÊ•öÔºÅ', '‰∏çÊòØÊàëÁöÑÈîôÔºÅ'
                ],
                emoji: 'üìû'
            },
            quality_issue: {
                name: 'Ë¥®ÈáèÈóÆÈ¢òÈîÖ',
                color: '#ff9f43',
                basePoints: 200,
                size: 80,
                speedRange: [0.5, 1.0],
                complaints: [
                    'ËçØÂìÅÂéãÊçü‰∏çÂÖ≥Êàë‰∫ãÔºÅ', 'ËøôÊòØÁâ©ÊµÅÈóÆÈ¢òÔºÅ', 'ÈÄÄÁæ§ÁÆó‰∫ÜÔºÅ', 'Ë¥®ÈáèÈÉ®Èó®Ë¥üË¥£ÔºÅ',
                    '‰∏çÊòØÊàë‰ª¨ÁöÑË¥ßÔºÅ', '‰æõÂ∫îÂïÜÁöÑÈóÆÈ¢òÔºÅ', 'ËøêËæìÈÄî‰∏≠ÁöÑ‰∫ãÔºÅ', 'ÂåÖË£Ö‰∏çÊòØÊàëË¥üË¥£ÁöÑÔºÅ',
                    'Ëøô‰∏™ÊâπÊ¨°ÊúâÈóÆÈ¢òÔºÅ', '‰ªìÂ∫ìÁÆ°ÁêÜÁöÑ‰∫ãÔºÅ', '‰∏çÊòØË¥®ÈáèÈóÆÈ¢òÔºÅ', 'ÂÆ¢Êà∑‰øùÂ≠ò‰∏çÂΩìÔºÅ',
                    'ÁéØÂ¢ÉÊ∏©Â∫¶ÂØºËá¥ÁöÑÔºÅ', 'Ëøô‰∏™ÊàëÊ£ÄÊü•Ëøá‰∫ÜÔºÅ', '‰∏çÊòØÊàë‰ª¨ËÉΩÊéßÂà∂ÁöÑÔºÅ', '‰æõÂ∫îÈìæÁöÑÈîÖÔºÅ',
                    'ÂéüÊùêÊñôÂ∞±ÊúâÈóÆÈ¢òÔºÅ', 'Áîü‰∫ßÂ∑•Ëâ∫ÈóÆÈ¢òÔºÅ', '‰∏çÂú®Ë¥®‰øùËåÉÂõ¥ÔºÅ', 'Ëøô‰∏™Ë¶ÅÊâæÂéÇÂÆ∂ÔºÅ',
                    'Ê£ÄÈ™åÊ†áÂáÜ‰∏çÂêåÔºÅ', 'ÂÆ¢Êà∑‰ΩøÁî®ÊñπÊ≥ïÈîôËØØÔºÅ', '‰øùË¥®ÊúüÂÜÖÊ≠£Â∏∏ÔºÅ', 'ËøêËæìÈ¢†Á∞∏ÂØºËá¥ÁöÑÔºÅ'
                ],
                emoji: 'üíä'
            },
            meeting_pot: {
                name: 'ÂºÄ‰ºöÁî©ÈîÖ',
                color: '#00d2d3',
                basePoints: 120,
                size: 65,
                speedRange: [1.3, 2.0],
                complaints: [
                    'ÂºÄ‰ªÄ‰πà‰ºöÂïäÔºÅ', 'Êµ™Ë¥πÊó∂Èó¥ÔºÅ', 'ÊàëÂÖàÈÄÄ‰∫ÜÔºÅ', '‰ºöËÆÆÂ§™Â§ö‰∫ÜÔºÅ',
                    'Ê≤°ÊúâÊÑè‰πâÁöÑ‰ºöÔºÅ', 'ÊàëÊúâÂÖ∂‰ªñ‰∫ãÔºÅ', '‰ºöËÆÆÊïàÁéá‰ΩéÔºÅ', 'ÂèàË¶ÅÂºÄ‰ºöÔºÅ',
                    'ËÆÆÈ¢ò‰∏çÊ∏ÖÊ•öÔºÅ', 'Êàë‰∏çÈúÄË¶ÅÂèÇÂä†ÔºÅ', 'Êó∂Èó¥ÂÆâÊéí‰∏çÂêàÁêÜÔºÅ', '‰ºöËÆÆÂÆ§Â§™ÂêµÔºÅ',
                    'ËÆ®ËÆ∫Ê≤°ÁªìÊûúÔºÅ', '‰ºöËÆÆÊó∂Èó¥Â§™ÈïøÔºÅ', 'ÊàëÊ≤°ÊúâÂèëË®ÄÊùÉÔºÅ', 'ÂÜ≥Á≠ñ‰∏çÂÖ≥Êàë‰∫ãÔºÅ',
                    '‰ºöËÆÆÈÄöÁü•Â§™ÊôöÔºÅ', 'ËÆÆÁ®ãÂÆâÊéíÊúâÈóÆÈ¢òÔºÅ', 'ÊàëÂè™ÊòØÂàóÂ∏≠ÁöÑÔºÅ', 'Ëøô‰∏™‰ºöÊ≤°ÂøÖË¶ÅÔºÅ',
                    'ÊàëÊúâÁ¥ßÊÄ•‰∫ãÂä°ÔºÅ', '‰ºöËÆÆÂÜ≤Á™Å‰∫ÜÔºÅ', 'ËÆ®ËÆ∫ÂÅèÁ¶ª‰∏ªÈ¢òÔºÅ', 'ÁªìËÆ∫‰∏çÊòéÁ°ÆÔºÅ'
                ],
                emoji: 'üë•'
            },
            boss_pot: {
                name: 'ËÄÅÊùøÈîÖ',
                color: '#feca57',
                basePoints: 300,
                size: 90,
                speedRange: [0.3, 0.8],
                complaints: [
                    'ËÄÅÊùøÁöÑÈîÖÊàë‰∏çËÉåÔºÅ', 'ËøôÊòØÁÆ°ÁêÜÈóÆÈ¢òÔºÅ', 'ÊàëÂè™ÊòØÊâßË°åÁöÑÔºÅ', 'ÂÜ≥Á≠ñ‰∏çÊòØÊàëÂÆöÁöÑÔºÅ',
                    'ËÄÅÊùøÊ≤°ËØ¥Ê∏ÖÊ•öÔºÅ', 'ÊåáÁ§∫Ê®°Á≥ä‰∏çÊ∏ÖÔºÅ', 'ÊàëÊåâË¶ÅÊ±ÇÂÅöÁöÑÔºÅ', 'Ëøô‰∏™Ë¶ÅÈóÆËÄÅÊùøÔºÅ',
                    'ÁÆ°ÁêÜÂ±ÇÁöÑÂÜ≥ÂÆöÔºÅ', 'ÊàëÊ≤°ÊúâÂÜ≥Á≠ñÊùÉÔºÅ', 'ËÄÅÊùøË¶ÅÊ±ÇÁöÑÔºÅ', '‰∏çÊòØÊàëÁöÑË¥£‰ªªÔºÅ',
                    '‰∏äÁ∫ßÊåáÁ§∫ÊúâÈóÆÈ¢òÔºÅ', 'ËÄÅÊùøÊîπ‰∏ªÊÑè‰∫ÜÔºÅ', 'ÊîøÁ≠ñÊúù‰ª§Â§ïÊîπÔºÅ', 'ÊàëÂè™ÊòØÂê¨ÂëΩË°å‰∫ãÔºÅ',
                    'ËÄÅÊùøÊ≤°ÊúâËÄÉËôëÂë®ÂÖ®ÔºÅ', 'ÂÜ≥Á≠ñ‰æùÊçÆ‰∏çË∂≥ÔºÅ', 'ËÄÅÊùøÂ§™ÁùÄÊÄ•‰∫ÜÔºÅ', 'Ëøô‰∏™È£éÈô©ÂæàÂ§ßÔºÅ',
                    'ËÄÅÊùø‰∏ç‰∫ÜËß£ÊÉÖÂÜµÔºÅ', 'ÊâßË°åÂ±ÇÈù¢ÊúâÂõ∞ÈöæÔºÅ', 'ËµÑÊ∫ê‰∏çÂ§üÊîØÊåÅÔºÅ', 'Êó∂Èó¥ÂÆâÊéí‰∏çÁé∞ÂÆûÔºÅ',
                    'ËÄÅÊùøÊúüÊúõÂ§™È´òÔºÅ', 'ÁõÆÊ†á‰∏çÂàáÂÆûÈôÖÔºÅ', 'ÊàëÊó©Â∞±ÊèêÈÜíËøáÔºÅ', 'ËÄÅÊùø‰∏çÂê¨Âª∫ËÆÆÔºÅ'
                ],
                emoji: 'üëî'
            },
            // ÁâπÊÆäÈîÖÂ≠ê
            bonus_pot: {
                name: 'Â•ñÂä±ÈáëÈîÖ',
                color: '#f1c40f',
                basePoints: 500,
                size: 85,
                speedRange: [1.8, 2.5],
                complaints: ['Â•ñÂä±ÔºÅÂ•ñÂä±ÔºÅ', 'ÈáëÂ∏ÅgetÔºÅ', 'ÂèëË¥¢Âï¶ÔºÅ'],
                emoji: 'üí∞',
                special: true
            },
            bomb_pot: {
                name: 'ÁÇ∏ÂºπÈªëÈîÖ',
                color: '#2c3e50',
                basePoints: -200,
                size: 95,
                speedRange: [0.2, 0.6],
                complaints: ['Â∞èÂøÉÁàÜÁÇ∏ÔºÅ', 'Âç±Èô©ÔºÅÂç±Èô©ÔºÅ', 'ËøôÈîÖÊúâÊØíÔºÅ'],
                emoji: 'üí£',
                special: true
            }
        };

        // Â∫∑Â∫∑ÂêêÊßΩÂçáÁ∫ßÁâà
        const kangkangComplaints = [
            'Ëøô‰∏™ÈîÖÊàë‰∏çËÉåÔºÅ', 'ÊòéÊòæÊòØËøêËê•ÁöÑ‰∫ãÔºÅ', 'ÈÄÄÁæ§ÈÄÄÁæ§ÔºÅ', 'ÊâæÂ∞èÊ¨ßÂéªÔºÅ', '‰∏çÂÖ≥Êàë‰∫ãÔºÅ',
            'ËøôÊµÅÁ®ãÊúâÈóÆÈ¢òÔºÅ', 'ÊàëÁÆ°È¶ñÊé®‰∏çÁÆ°ÈÄÄË¥ßÔºÅ', 'Áî©ÈîÖÂ§ßÊ≥ïÂ•ΩÔºÅ', 'ÂèàË¶ÅÁî©ÈîÖ‰∫ÜÔºÅ', 'ÁúãÊàëÁ•ûÊäÄÔºÅ',
            'ÈîÖÊù•‰∫ÜÈîÖÊù•‰∫ÜÔºÅ', 'Áî©ÈîÖÂ∞èËÉΩÊâã‰∏äÁ∫øÔºÅ', 'Ëøô‰∏™Ë¥£‰ªª‰∏çÊòØÊàëÁöÑÔºÅ', 'Á≥ªÁªüÈóÆÈ¢òÊâæITÔºÅ',
            'ÂÆ¢Êà∑ÈóÆÈ¢òÊâæÂÆ¢ÊúçÔºÅ', 'Ë¥®ÈáèÈóÆÈ¢òÊâæË¥®Ê£ÄÔºÅ', 'ÊµÅÁ®ãÈóÆÈ¢òÊâæËøêËê•ÔºÅ', 'ÁÆ°ÁêÜÈóÆÈ¢òÊâæËÄÅÊùøÔºÅ',
            'ÊàëÂè™ÊòØË¥üË¥£È¶ñÊé®ÔºÅ', 'ÈÄÄË¥ß‰∏çÊòØÊàëÁÆ°ÁöÑÔºÅ', 'OAÊµÅÁ®ãÂ§™Â§çÊùÇÔºÅ', 'Ë∞ÅËÆæËÆ°ÁöÑÁ†¥Á≥ªÁªüÔºÅ',
            'Áî©ÈîÖÊäÄËÉΩMAXÔºÅ', 'ÈîÖÈîÖÈîÖÔºåÊª°Â§©È£ûÔºÅ', 'Ë¥£‰ªªÈÉΩÊòØÂà´‰∫∫ÁöÑÔºÅ', 'ÊàëÊòØÊó†ËæúÁöÑÔºÅ',
            'ÂèàÊù•Áî©ÈîÖÂï¶ÔºÅ', 'ËøôÈîÖ‰∏çÊòØÊàëÁöÑÔºÅ', 'Ë¥£‰ªªÊé®Âç∏‰∏≠...', 'Êàë‰ªÄ‰πàÈÉΩ‰∏çÁü•ÈÅìÔºÅ'
        ];

        // Âπ≥Â∫ïÈîÖÁ±ªÔºà‰ΩøÁî®Konva.jsÈáçÊûÑ - Ê∑ªÂä†ÈÄüÂ∫¶ÂΩ±ÂìçÂæóÂàÜÔºâ
        class PanPro {
            constructor(type) {
                this.type = type;
                this.data = panTypes[type];
                this.sliced = false;
                this.x = 150;
                this.y = gameEngine.height - 100;
                
                // ÈöèÊú∫ÈÄüÂ∫¶Á≥ªÊï∞ÔºàÂú®ÊåáÂÆöËåÉÂõ¥ÂÜÖÔºâ
                const speedRange = this.data.speedRange;
                this.speedMultiplier = Math.random() * (speedRange[1] - speedRange[0]) + speedRange[0];
                
                // Ê†πÊçÆÈÄüÂ∫¶ËÆ°ÁÆóÂæóÂàÜÔºàÈÄüÂ∫¶Ë∂äÂø´ÂæóÂàÜË∂äÈ´òÔºâ
                this.points = Math.round(this.data.basePoints * (0.5 + this.speedMultiplier));
                
                // Â§öÊ†∑ÂåñÈ£ûË°åË∑ØÂæÑ
                const throwStyle = Math.floor(Math.random() * 5);
                switch(throwStyle) {
                    case 0: // È´òÊäõÁâ©Á∫ø
                        this.vx = (Math.random() * 10 + 12) * this.speedMultiplier;
                        this.vy = -(Math.random() * 18 + 18);
                        break;
                    case 1: // ‰ΩéÂπ≥Êäõ
                        this.vx = (Math.random() * 15 + 15) * this.speedMultiplier;
                        this.vy = -(Math.random() * 8 + 8);
                        break;
                    case 2: // ‰∏≠Á≠âÂºßÂ∫¶
                        this.vx = (Math.random() * 12 + 12) * this.speedMultiplier;
                        this.vy = -(Math.random() * 12 + 12);
                        break;
                    case 3: // Ë∂ÖËøúË∑ùÁ¶ª
                        this.vx = (Math.random() * 18 + 18) * this.speedMultiplier;
                        this.vy = -(Math.random() * 22 + 22);
                        break;
                    case 4: // ÈöèÊú∫ÂºπË∑≥
                        this.vx = (Math.random() * 8 + 10) * this.speedMultiplier;
                        this.vy = -(Math.random() * 15 + 20);
                        this.bouncy = true;
                        break;
                }
                
                this.gravity = 0.5;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.5 * this.speedMultiplier;
                this.size = this.data.size + Math.random() * 20;
                this.trail = [];
                
                this.createKonvaObject();
            }

            createKonvaObject() {
                // ÂàõÂª∫Âπ≥Â∫ïÈîÖÁªÑ
                this.group = new Konva.Group({
                    x: this.x,
                    y: this.y
                });

                // ÂàõÂª∫‰∏ª‰ΩìÂúÜÂΩ¢ÔºàÊ†πÊçÆÈÄüÂ∫¶Ë∞ÉÊï¥È¢úËâ≤Ê∑±Â∫¶Ôºâ
                const colorIntensity = Math.min(1, this.speedMultiplier / 2);
                this.circle = new Konva.Circle({
                    radius: this.size / 2,
                    fill: this.data.color,
                    stroke: '#333',
                    strokeWidth: 4,
                    shadowColor: 'rgba(0,0,0,0.5)',
                    shadowBlur: 10,
                    shadowOffset: { x: 5, y: 5 },
                    opacity: 0.8 + colorIntensity * 0.2
                });

                // ÂàõÂª∫ÈîÖÊüÑ
                this.handle = new Konva.Rect({
                    x: this.size / 2,
                    y: -8,
                    width: this.size / 2.5,
                    height: 16,
                    fill: '#8B4513',
                    stroke: '#333',
                    strokeWidth: 2,
                    cornerRadius: 8
                });

                // ÂàõÂª∫Ë°®ÊÉÖÁ¨¶Âè∑ÊñáÊú¨
                this.emoji = new Konva.Text({
                    text: this.data.emoji,
                    fontSize: this.size / 2.5,
                    fontFamily: 'Arial',
                    fill: 'white',
                    stroke: '#333',
                    strokeWidth: 2,
                    align: 'center',
                    verticalAlign: 'middle',
                    offsetX: this.size / 5,
                    offsetY: this.size / 5
                });

                // ÈÄüÂ∫¶ÊåáÁ§∫Âô®ÔºàÂø´ÈÄüÈîÖÂ≠êÊúâÂÖâÁéØÊïàÊûúÔºâ
                if (this.speedMultiplier > 1.5) {
                    this.speedGlow = new Konva.Circle({
                        radius: this.size / 2 + 8,
                        stroke: '#ffff00',
                        strokeWidth: 3,
                        opacity: 0.6,
                        dash: [5, 5]
                    });
                    this.group.add(this.speedGlow);
                }

                // Ê∑ªÂä†Âà∞ÁªÑ
                this.group.add(this.circle);
                this.group.add(this.handle);
                this.group.add(this.emoji);

                // Ê∑ªÂä†Âà∞Ê∏∏ÊàèÂ±Ç
                gameEngine.layer.add(this.group);
            }

            update() {
                if (this.sliced) return;

                // Áâ©ÁêÜÊõ¥Êñ∞
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.rotation += this.rotationSpeed;

                // ÂºπË∑≥ÊïàÊûú
                if (this.bouncy && this.y > gameEngine.height - 200 && this.vy > 0) {
                    this.vy *= -0.7;
                    this.bouncy = false;
                }

                // Êõ¥Êñ∞KonvaÂØπË±°‰ΩçÁΩÆ
                this.group.x(this.x);
                this.group.y(this.y);
                this.group.rotation(this.rotation);

                // ÈÄüÂ∫¶ÂÖâÁéØÂä®Áîª
                if (this.speedGlow) {
                    this.speedGlow.rotation(this.speedGlow.rotation() + 2);
                }

                // Ê∑ªÂä†ËΩ®ËøπÁÇπ
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > 15) {
                    this.trail.shift();
                }

                // ÁªòÂà∂ËΩ®Ëøπ
                this.drawTrail();
            }

            drawTrail() {
                // Ê∏ÖÈô§‰πãÂâçÁöÑËΩ®Ëøπ
                if (this.trailLine) {
                    this.trailLine.destroy();
                }

                if (this.trail.length > 2) {
                    const points = [];
                    this.trail.forEach(point => {
                        points.push(point.x, point.y);
                    });

                    this.trailLine = new Konva.Line({
                        points: points,
                        stroke: this.data.color,
                        strokeWidth: Math.max(4, 6 * this.speedMultiplier / 2),
                        opacity: 0.4 + this.speedMultiplier * 0.1,
                        lineCap: 'round',
                        lineJoin: 'round'
                    });

                    gameEngine.particleLayer.add(this.trailLine);
                }
            }

            isPointInside(x, y) {
                const distance = Math.sqrt((x - this.x) ** 2 + (y - this.y) ** 2);
                return distance < this.size / 2;
            }

            slice() {
                if (this.sliced) return 0;
                
                this.sliced = true;
                
                // Êí≠ÊîæÈü≥Êïà
                soundSystem.playSlice();
                
                // ÂàõÂª∫ÂàáÂâ≤ÊïàÊûú
                this.createSliceEffect();
                
                // ÊòæÁ§∫ÂêêÊßΩ
                this.showComplaint();
                
                // ÈöêËóèÂØπË±°
                if (typeof gsap !== 'undefined') {
                    gsap.to(this.group, {
                        duration: 0.5,
                        scaleX: 0,
                        scaleY: 0,
                        rotation: 360,
                        opacity: 0,
                        onComplete: () => {
                            this.destroy();
                        }
                    });
                } else {
                    setTimeout(() => {
                        this.destroy();
                    }, 500);
                }

                return this.points;
            }

            createSliceEffect() {
                // ÂàõÂª∫Á≤íÂ≠êÁàÜÁÇ∏ÊïàÊûúÔºàÊ†πÊçÆÈÄüÂ∫¶Ë∞ÉÊï¥Á≤íÂ≠êÊï∞ÈáèÔºâ
                const particleCount = Math.round(20 + this.speedMultiplier * 10);
                for (let i = 0; i < particleCount; i++) {
                    const particle = new Konva.Circle({
                        x: this.x + (Math.random() - 0.5) * this.size,
                        y: this.y + (Math.random() - 0.5) * this.size,
                        radius: Math.random() * 8 + 4,
                        fill: this.data.color,
                        opacity: 1
                    });

                    gameEngine.effectLayer.add(particle);

                    // Á≤íÂ≠êÂä®Áîª
                    if (typeof gsap !== 'undefined') {
                        gsap.to(particle, {
                            duration: 1 + this.speedMultiplier * 0.5,
                            x: particle.x() + (Math.random() - 0.5) * 200 * this.speedMultiplier,
                            y: particle.y() + Math.random() * 200 + 100,
                            opacity: 0,
                            scaleX: 0.1,
                            scaleY: 0.1,
                            onComplete: () => particle.destroy()
                        });
                    } else {
                        setTimeout(() => particle.destroy(), 1000);
                    }
                }

                // ÂàáÂâ≤Èó™ÂÖâÊïàÊûú
                const flash = new Konva.Star({
                    x: this.x,
                    y: this.y,
                    numPoints: 8,
                    innerRadius: 20,
                    outerRadius: 40 + this.speedMultiplier * 10,
                    fill: 'white',
                    opacity: 0.8
                });

                gameEngine.effectLayer.add(flash);

                if (typeof gsap !== 'undefined') {
                    gsap.to(flash, {
                        duration: 0.3,
                        scaleX: 3,
                        scaleY: 3,
                        opacity: 0,
                        onComplete: () => flash.destroy()
                    });
                } else {
                    setTimeout(() => flash.destroy(), 300);
                }
            }

            showComplaint() {
                const complaints = this.data.complaints;
                const randomComplaint = complaints[Math.floor(Math.random() * complaints.length)];
                
                const complaintElement = document.createElement('div');
                complaintElement.className = 'slice-complaint-pro';
                complaintElement.textContent = `${randomComplaint} (+${this.points})`;
                complaintElement.style.left = this.x + 'px';
                complaintElement.style.top = this.y + 'px';
                
                // Âø´ÈÄüÈîÖÂ≠êÁöÑÁâπÊÆäÊ†∑Âºè
                if (this.speedMultiplier > 1.5) {
                    complaintElement.style.background = 'linear-gradient(45deg, rgba(255,215,0,0.9), rgba(255,237,78,0.8))';
                    complaintElement.style.color = '#333';
                    complaintElement.style.fontWeight = '900';
                }
                
                document.getElementById('gameScreen').appendChild(complaintElement);
                
                // GSAPÂä®Áîª
                if (typeof gsap !== 'undefined') {
                    gsap.fromTo(complaintElement, 
                        {
                            scale: 0,
                            rotation: -15,
                            y: this.y
                        },
                        {
                            duration: 0.3,
                            scale: 1,
                            rotation: 0,
                            ease: "back.out(1.7)"
                        }
                    );

                    gsap.to(complaintElement, {
                        delay: 2,
                        duration: 0.5,
                        y: this.y - 100,
                        opacity: 0,
                        scale: 0.8,
                        onComplete: () => {
                            if (complaintElement.parentNode) {
                                complaintElement.parentNode.removeChild(complaintElement);
                            }
                        }
                    });
                } else {
                    setTimeout(() => {
                        if (complaintElement.parentNode) {
                            complaintElement.parentNode.removeChild(complaintElement);
                        }
                    }, 2500);
                }
            }

            destroy() {
                if (this.group) this.group.destroy();
                if (this.trailLine) this.trailLine.destroy();
            }

            isOffScreen() {
                return this.y > gameEngine.height + 100 || this.x > gameEngine.width + 100 || this.x < -100;
            }
        }

        // ÊäÄËÉΩÁ≥ªÁªü
        const skillSystem = {
            slowTime: {
                name: 'Êó∂Èó¥ÂáèÁºì',
                cooldown: 20,
                duration: 5,
                activate: () => {
                    if (typeof gsap !== 'undefined') {
                        gsap.globalTimeline.timeScale(0.3);
                        document.getElementById('slowTimeSkill').classList.add('cooldown');
                        
                        setTimeout(() => {
                            gsap.globalTimeline.timeScale(1);
                        }, 5000);
                        
                        setTimeout(() => {
                            document.getElementById('slowTimeSkill').classList.remove('cooldown');
                        }, 20000);
                    }
                }
            },
            multiSlice: {
                name: 'Â§öÈáçÂàáÂâ≤',
                cooldown: 15,
                duration: 8,
                activate: () => {
                    gameState.skills.multiSlice.duration = 8;
                    document.getElementById('multiSliceSkill').classList.add('cooldown');
                    
                    setTimeout(() => {
                        gameState.skills.multiSlice.duration = 0;
                    }, 8000);
                    
                    setTimeout(() => {
                        document.getElementById('multiSliceSkill').classList.remove('cooldown');
                    }, 15000);
                }
            },
            scoreBonus: {
                name: 'ÂàÜÊï∞Âä†Êàê',
                cooldown: 25,
                duration: 10,
                activate: () => {
                    gameState.skills.scoreBonus.duration = 10;
                    document.getElementById('scoreBonusSkill').classList.add('cooldown');
                    
                    setTimeout(() => {
                        gameState.skills.scoreBonus.duration = 0;
                    }, 10000);
                    
                    setTimeout(() => {
                        document.getElementById('scoreBonusSkill').classList.remove('cooldown');
                    }, 25000);
                }
            }
        };

        // ÂàùÂßãÂåñÁ≤íÂ≠êËÉåÊôØ
        function initParticles() {
            if (typeof particlesJS !== 'undefined') {
                particlesJS('particles-js', {
                    particles: {
                        number: { value: 120 },
                        color: { value: ["#667eea", "#764ba2", "#ff6b6b"] },
                        shape: { type: "circle" },
                        size: { value: 3, random: true },
                        move: {
                            enable: true,
                            speed: 2,
                            direction: "none",
                            random: true,
                            out_mode: "out"
                        },
                        opacity: { value: 0.6, random: true }
                    },
                    interactivity: {
                        events: {
                            onhover: { enable: true, mode: "repulse" },
                            onclick: { enable: true, mode: "push" }
                        }
                    }
                });
            }
        }

        // ÂàùÂßãÂåñÊ∏∏ÊàèÂºïÊìé
        function initGameEngine() {
            gameEngine.width = window.innerWidth;
            gameEngine.height = window.innerHeight;

            gameEngine.stage = new Konva.Stage({
                container: 'gameContainer',
                width: gameEngine.width,
                height: gameEngine.height
            });

            gameEngine.layer = new Konva.Layer();
            gameEngine.particleLayer = new Konva.Layer();
            gameEngine.effectLayer = new Konva.Layer();

            gameEngine.stage.add(gameEngine.layer);
            gameEngine.stage.add(gameEngine.particleLayer);
            gameEngine.stage.add(gameEngine.effectLayer);

            // Èº†Ê†áËΩ®Ëøπ
            let mouseTrail = [];
            let trailLine = null;

            gameEngine.stage.on('mousemove touchmove', (e) => {
                if (!gameEngine.running) return;

                const pos = gameEngine.stage.getPointerPosition();
                if (!pos) return;

                mouseTrail.push({ x: pos.x, y: pos.y, time: Date.now() });
                if (mouseTrail.length > 15) {
                    mouseTrail.shift();
                }

                // Ê∏ÖÁêÜËøáÊúüËΩ®Ëøπ
                const now = Date.now();
                mouseTrail = mouseTrail.filter(point => now - point.time < 300);

                // ÁªòÂà∂ÂàÄÂÖâËΩ®Ëøπ
                if (trailLine) trailLine.destroy();
                
                if (mouseTrail.length > 2) {
                    const points = [];
                    mouseTrail.forEach(point => {
                        points.push(point.x, point.y);
                    });

                    trailLine = new Konva.Line({
                        points: points,
                        stroke: '#ffffff',
                        strokeWidth: 12,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round',
                        shadowColor: '#87CEEB',
                        shadowBlur: 20
                    });

                    gameEngine.effectLayer.add(trailLine);
                }

                // Ê£ÄÊü•ÂàáÂâ≤
                checkSlice(pos.x, pos.y);
            });

            // ÊäÄËÉΩÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('slowTimeSkill').addEventListener('click', () => {
                if (!document.getElementById('slowTimeSkill').classList.contains('cooldown')) {
                    skillSystem.slowTime.activate();
                }
            });

            document.getElementById('multiSliceSkill').addEventListener('click', () => {
                if (!document.getElementById('multiSliceSkill').classList.contains('cooldown')) {
                    skillSystem.multiSlice.activate();
                }
            });

            document.getElementById('scoreBonusSkill').addEventListener('click', () => {
                if (!document.getElementById('scoreBonusSkill').classList.contains('cooldown')) {
                    skillSystem.scoreBonus.activate();
                }
            });
        }

        // Ê£ÄÊü•ÂàáÂâ≤
        function checkSlice(x, y) {
            if (!gameEngine.running) return;
            
            let slicedCount = 0;
            const maxSlices = gameState.skills.multiSlice.duration > 0 ? 5 : 1;
            
            for (let i = gameState.pans.length - 1; i >= 0 && slicedCount < maxSlices; i--) {
                const pan = gameState.pans[i];
                if (!pan.sliced && pan.isPointInside(x, y)) {
                    let points = pan.slice();
                    
                    // ÂàÜÊï∞Âä†ÊàêÊäÄËÉΩ
                    if (gameState.skills.scoreBonus.duration > 0) {
                        points *= 2;
                    }
                    
                    gameState.score += points;
                    gameState.combo++;
                    slicedCount++;
                    
                    // ËøûÂáªÊïàÊûú
                    if (gameState.combo > 1) {
                        showComboEffect(x, y, gameState.combo);
                        soundSystem.playCombo();
                    }
                    
                    // ÊòæÁ§∫ÂæóÂàÜ
                    showScoreEffect(x, y, points);
                    
                    updateUI();
                    
                    // ÁßªÈô§ÈîÖÂ≠ê
                    setTimeout(() => {
                        const index = gameState.pans.indexOf(pan);
                        if (index > -1) {
                            gameState.pans.splice(index, 1);
                        }
                    }, 500);
                }
            }
        }

        // ÊòæÁ§∫ËøûÂáªÊïàÊûú
        function showComboEffect(x, y, comboCount) {
            const comboElement = document.createElement('div');
            comboElement.className = 'combo-effect';
            comboElement.textContent = `${comboCount}x COMBO!`;
            comboElement.style.left = x + 'px';
            comboElement.style.top = y + 'px';
            
            document.getElementById('gameScreen').appendChild(comboElement);
            
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(comboElement, 
                    {
                        scale: 0,
                        rotation: 180,
                        y: y
                    },
                    {
                        duration: 0.5,
                        scale: 1.5,
                        rotation: 0,
                        y: y - 50,
                        ease: "back.out(2)"
                    }
                );

                gsap.to(comboElement, {
                    delay: 1,
                    duration: 0.5,
                    scale: 0,
                    opacity: 0,
                    onComplete: () => {
                        if (comboElement.parentNode) {
                            comboElement.parentNode.removeChild(comboElement);
                        }
                    }
                });
            } else {
                setTimeout(() => {
                    if (comboElement.parentNode) {
                        comboElement.parentNode.removeChild(comboElement);
                    }
                }, 1500);
            }
        }

        // ÊòæÁ§∫ÂæóÂàÜÊïàÊûú
        function showScoreEffect(x, y, points) {
            const scoreText = new Konva.Text({
                x: x,
                y: y,
                text: `+${points}`,
                fontSize: 32,
                fontFamily: 'Orbitron',
                fontStyle: 'bold',
                fill: points > 200 ? '#f1c40f' : 'white',
                stroke: '#333',
                strokeWidth: 2,
                offsetX: 20,
                offsetY: 16
            });

            gameEngine.effectLayer.add(scoreText);

            if (typeof gsap !== 'undefined') {
                gsap.to(scoreText, {
                    duration: 1,
                    y: y - 80,
                    scaleX: 1.5,
                    scaleY: 1.5,
                    opacity: 0,
                    onComplete: () => scoreText.destroy()
                });
            } else {
                setTimeout(() => scoreText.destroy(), 1000);
            }
        }

        // ÁîüÊàêÂπ≥Â∫ïÈîÖ
        function spawnPan() {
            if (!gameEngine.running) return;
            
            const types = Object.keys(panTypes);
            let randomType;
            
            // ÁâπÊÆäÈîÖÂ≠êÊ¶ÇÁéáÊéßÂà∂
            const random = Math.random();
            if (random < 0.05) { // 5%Ê¶ÇÁéáÂ•ñÂä±ÈîÖ
                randomType = 'bonus_pot';
            } else if (random < 0.08) { // 3%Ê¶ÇÁéáÁÇ∏ÂºπÈîÖ
                randomType = 'bomb_pot';
            } else {
                const normalTypes = types.filter(type => !panTypes[type].special);
                randomType = normalTypes[Math.floor(Math.random() * normalTypes.length)];
            }
            
            const pan = new PanPro(randomType);
            gameState.pans.push(pan);
            
            // Êí≠ÊîæÊäïÊé∑Èü≥Êïà
            soundSystem.playThrow();
            
            // Â∫∑Â∫∑ËØ¥ËØù
            showKangkangSpeech();
        }

        // Â∫∑Â∫∑ËØ¥ËØùÔºàÂª∂ÈïøÂà∞5ÁßíÔºâ
        function showKangkangSpeech() {
            const bubble = document.getElementById('speechBubble');
            const randomComplaint = kangkangComplaints[Math.floor(Math.random() * kangkangComplaints.length)];
            
            bubble.textContent = randomComplaint;
            bubble.classList.remove('hidden');
            
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(bubble, 
                    {
                        scale: 0,
                        rotation: -20
                    },
                    {
                        duration: 0.5,
                        scale: 1,
                        rotation: 0,
                        ease: "back.out(1.7)"
                    }
                );
                
                setTimeout(() => {
                    gsap.to(bubble, {
                        duration: 0.4,
                        scale: 0,
                        rotation: 20,
                        onComplete: () => {
                            bubble.classList.add('hidden');
                        }
                    });
                }, 6000); // Âª∂ÈïøÂà∞6Áßí
            } else {
                setTimeout(() => {
                    bubble.classList.add('hidden');
                }, 6000);
            }
        }

        // Ê∏∏ÊàèÂæ™ÁéØ
        function gameLoop() {
            if (!gameEngine.running) return;
            
            // Êõ¥Êñ∞ÊâÄÊúâÈîÖÂ≠ê
            for (let i = gameState.pans.length - 1; i >= 0; i--) {
                const pan = gameState.pans[i];
                pan.update();
                
                if (pan.isOffScreen()) {
                    if (!pan.sliced) {
                        gameState.combo = 0;
                        updateUI();
                    }
                    pan.destroy();
                    gameState.pans.splice(i, 1);
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Êõ¥Êñ∞UI
        function updateUI() {
            document.getElementById('score').textContent = gameState.score.toLocaleString();
            document.getElementById('combo').textContent = gameState.combo;
            document.getElementById('time').textContent = gameState.timeLeft;
            
            if (gameState.combo > gameState.maxCombo) {
                gameState.maxCombo = gameState.combo;
            }
        }

        // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØ
        function startGameLoop() {
            gameEngine.running = true;
            
            // ËÆ°Êó∂Âô®
            gameTimer = setInterval(() => {
                gameState.timeLeft--;
                updateUI();
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                    clearInterval(gameTimer);
                    clearInterval(spawnTimer);
                    return;
                }
                
                // ÈöæÂ∫¶ÈÄíÂ¢û
                if (gameState.timeLeft % 10 === 0 && gameState.spawnRate > 200) {
                    gameState.spawnRate -= 100;
                    clearInterval(spawnTimer);
                    spawnTimer = setInterval(spawnPan, gameState.spawnRate);
                }
            }, 1000);

            // ÁîüÊàêÂπ≥Â∫ïÈîÖÂÆöÊó∂Âô®
            spawnTimer = setInterval(spawnPan, gameState.spawnRate);
            
            // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØ
            gameLoop();
        }

        // ÁªìÊùüÊ∏∏Êàè
        async function endGame() {
            gameEngine.running = false;
            
            await saveScore();
            await loadLeaderboard();
            showGameOver();
        }

        // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùüÁïåÈù¢
        async function showGameOver() {
            const gameOverElement = document.getElementById('gameOver');
            const titleElement = document.getElementById('gameOverTitle');
            const scoreElement = document.getElementById('gameOverScore');
            const rankElement = document.getElementById('gameOverRank');
            
            scoreElement.textContent = `ÊÇ®ÁöÑÂæóÂàÜ: ${gameState.score.toLocaleString()}`;
            
            const rank = await getPlayerRank();
            if (rank <= 10) {
                titleElement.textContent = 'üéâ ÊÅ≠Âñú‰∏äÊ¶úÔºÅ';
                rankElement.textContent = `ÊéíÂêç: Á¨¨${rank}Âêç | ÊúÄÈ´òËøûÂáª: ${gameState.maxCombo}`;
            } else {
                titleElement.textContent = 'ÁªßÁª≠Âä™ÂäõÂàáÈîÖÔºÅ';
                rankElement.textContent = `ÊéíÂêç: Á¨¨${rank}Âêç | ÊúÄÈ´òËøûÂáª: ${gameState.maxCombo}`;
            }
            
            gameOverElement.style.display = 'flex';
            
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(gameOverElement.querySelector('.game-over-box'), 
                    {
                        scale: 0,
                        rotation: 180
                    },
                    {
                        duration: 0.8,
                        scale: 1,
                        rotation: 0,
                        ease: "back.out(1.7)"
                    }
                );
            }
        }

        // ‰øùÂ≠òÂàÜÊï∞
        async function saveScore() {
            try {
                const playerRef = ref(database, `youxi/${gameState.player}`);
                const snapshot = await get(playerRef);
                
                if (snapshot.exists()) {
                    const currentBest = snapshot.val().score;
                    if (gameState.score > currentBest) {
                        await set(playerRef, {
                            nickname: gameState.player,
                            score: gameState.score,
                            maxCombo: gameState.maxCombo,
                            timestamp: Date.now()
                        });
                    }
                } else {
                    await set(playerRef, {
                        nickname: gameState.player,
                        score: gameState.score,
                        maxCombo: gameState.maxCombo,
                        timestamp: Date.now()
                    });
                }
            } catch (error) {
                console.error('‰øùÂ≠òÂàÜÊï∞Â§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÊéíË°åÊ¶ú
        async function loadLeaderboard() {
            try {
                const scoresRef = ref(database, 'youxi');
                const snapshot = await get(scoresRef);
                
                if (snapshot.exists()) {
                    const scores = [];
                    snapshot.forEach((child) => {
                        scores.push(child.val());
                    });
                    
                    scores.sort((a, b) => b.score - a.score);
                    displayLeaderboard(scores.slice(0, 10));
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊéíË°åÊ¶úÂ§±Ë¥•:', error);
            }
        }

        // ÊòæÁ§∫ÊéíË°åÊ¶ú
        function displayLeaderboard(scores) {
            const content = document.getElementById('leaderboardContent');
            content.innerHTML = '';
            
            scores.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = `leaderboard-item ${index < 3 ? 'top3' : ''}`;
                
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                
                item.innerHTML = `
                    <span>${medal} ${player.nickname}</span>
                    <span>${player.score.toLocaleString()}</span>
                `;
                
                content.appendChild(item);
                
                // Âä®ÁîªÊïàÊûú
                if (typeof gsap !== 'undefined') {
                    gsap.fromTo(item, 
                        {
                            x: -50,
                            opacity: 0
                        },
                        {
                            delay: index * 0.1,
                            duration: 0.5,
                            x: 0,
                            opacity: 1,
                            ease: "back.out(1.7)"
                        }
                    );
                }
            });
        }

        // Ëé∑ÂèñÁé©ÂÆ∂ÊéíÂêç
        async function getPlayerRank() {
            try {
                const scoresRef = ref(database, 'youxi');
                const snapshot = await get(scoresRef);
                
                if (snapshot.exists()) {
                    const scores = [];
                    snapshot.forEach((child) => {
                        scores.push(child.val());
                    });
                    
                    scores.sort((a, b) => b.score - a.score);
                    
                    for (let i = 0; i < scores.length; i++) {
                        if (scores[i].nickname === gameState.player) {
                            return i + 1;
                        }
                    }
                }
                return 999;
            } catch (error) {
                console.error('Ëé∑ÂèñÊéíÂêçÂ§±Ë¥•:', error);
                return 999;
            }
        }

        // Á°Æ‰øùÂÖ®Â±ÄÂáΩÊï∞ÂèØËÆøÈóÆ
        window.startGame = async function() {
            // ÂêØÁî®Èü≥È¢ë‰∏ä‰∏ãÊñáÔºàÊüê‰∫õÊµèËßàÂô®ÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            const nickname = document.getElementById('nicknameInput').value.trim();
            if (!nickname) {
                alert('ËØ∑ËæìÂÖ•ÊòµÁß∞ÂºÄÂßãÂàáÈîÖÔºÅ');
                return;
            }
            
            gameState.player = nickname;
            
            // ÁïåÈù¢ÂàáÊç¢Âä®Áîª
            if (typeof gsap !== 'undefined') {
                gsap.to(document.getElementById('loginScreen'), {
                    duration: 0.8,
                    opacity: 0,
                    scale: 0.8,
                    onComplete: () => {
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('gameScreen').classList.remove('hidden');
                        
                        gsap.fromTo(document.getElementById('gameScreen'), 
                            {
                                opacity: 0,
                                scale: 1.2
                            },
                            {
                                duration: 0.8,
                                opacity: 1,
                                scale: 1,
                                ease: "back.out(1.7)"
                            }
                        );
                    }
                });
            } else {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
            }
            
            await loadLeaderboard();
            initGameEngine();
            
            // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.timeLeft = 60;
            gameState.spawnRate = 1000;
            gameState.pans = [];
            
            updateUI();
            startGameLoop();
        };

        window.restartGame = function() {
            // Ê∏ÖÁêÜÂΩìÂâçÊ∏∏ÊàèÁä∂ÊÄÅ
            if (gameTimer) clearInterval(gameTimer);
            if (spawnTimer) clearInterval(spawnTimer);
            
            gameState.pans.forEach(pan => pan.destroy());
            gameState.pans = [];
            
            if (gameEngine.layer) gameEngine.layer.destroyChildren();
            if (gameEngine.particleLayer) gameEngine.particleLayer.destroyChildren();
            if (gameEngine.effectLayer) gameEngine.effectLayer.destroyChildren();
            
            if (typeof gsap !== 'undefined') {
                gsap.to(document.getElementById('gameOver'), {
                    duration: 0.5,
                    opacity: 0,
                    scale: 0.8,
                    onComplete: () => {
                        document.getElementById('gameOver').style.display = 'none';
                        
                        // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
                        gameState.score = 0;
                        gameState.combo = 0;
                        gameState.maxCombo = 0;
                        gameState.timeLeft = 60;
                        gameState.spawnRate = 1000;
                        
                        updateUI();
                        startGameLoop();
                    }
                });
            } else {
                document.getElementById('gameOver').style.display = 'none';
                
                // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
                gameState.score = 0;
                gameState.combo = 0;
                gameState.maxCombo = 0;
                gameState.timeLeft = 60;
                gameState.spawnRate = 1000;
                
                updateUI();
                startGameLoop();
            }
        };

        window.backToLogin = function() {
            // Ê∏ÖÁêÜÊ∏∏ÊàèÁä∂ÊÄÅ
            gameEngine.running = false;
            if (gameTimer) clearInterval(gameTimer);
            if (spawnTimer) clearInterval(spawnTimer);
            
            gameState.pans.forEach(pan => pan.destroy());
            gameState.pans = [];
            
            if (gameEngine.stage) {
                gameEngine.stage.destroy();
            }
            
            if (typeof gsap !== 'undefined') {
                gsap.to(document.getElementById('gameScreen'), {
                    duration: 0.5,
                    opacity: 0,
                    scale: 0.8,
                    onComplete: () => {
                        document.getElementById('gameScreen').classList.add('hidden');
                        document.getElementById('gameOver').style.display = 'none';
                        document.getElementById('loginScreen').classList.remove('hidden');
                        document.getElementById('nicknameInput').value = '';
                        
                        gsap.fromTo(document.getElementById('loginScreen'), 
                            {
                                opacity: 0,
                                scale: 1.2
                            },
                            {
                                duration: 0.8,
                                opacity: 1,
                                scale: 1,
                                ease: "back.out(1.7)"
                            }
                        );
                    }
                });
            } else {
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('nicknameInput').value = '';
            }
        };

        // Á™óÂè£Â§ßÂ∞èÂèòÂåñÊó∂ÈáçÊñ∞Ë∞ÉÊï¥
        window.addEventListener('resize', () => {
            if (gameEngine.stage) {
                gameEngine.width = window.innerWidth;
                gameEngine.height = window.innerHeight;
                gameEngine.stage.width(gameEngine.width);
                gameEngine.stage.height(gameEngine.height);
            }
        });

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        window.addEventListener('load', async () => {
            initParticles();
            await loadLeaderboard();
        });
    </script>
</body>
</html>
